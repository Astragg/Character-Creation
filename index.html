<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aetheria 11.0 ‚Äî Wired</title>
<style>
:root{--bg:#0b0b0d;--panel:rgba(28,28,30,0.85);--accent:#60cdff;--text:#eaeaea}
*{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto;}
body{margin:0;height:100vh;background:linear-gradient(180deg,#050505 0%, #0f1220 100%);color:var(--text);overflow:hidden}
canvas{position:absolute;inset:0;z-index:0}
#ui{position:absolute;inset:12px;display:flex;flex-direction:column;gap:12px;z-index:5;pointer-events:none}
.panel{background:var(--panel);backdrop-filter:blur(24px);border-radius:12px;padding:10px;border:1px solid rgba(255,255,255,0.04);pointer-events:auto}
#top{display:flex;gap:12px;align-items:center}
.stat{min-width:80px}
#tools{display:flex;gap:8px;align-items:center}
.btn{padding:6px 10px;border-radius:8px;border:none;background:rgba(255,255,255,0.03);color:var(--text);cursor:pointer}
#customize{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:50}
#customize .card{width:360px;padding:16px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01))}
.label{font-size:12px;color:#bfc7d3;margin-bottom:6px}
.input,select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}
#inspector{position:absolute;right:20px;top:80px;width:320px;max-height:70vh;overflow:auto}
.toast{position:fixed;right:20px;bottom:20px;z-index:60}
.small{font-size:12px;color:#bfc7d3}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="ui">
  <div id="top" class="panel">
    <div class="stat"><div class="small">Year</div><div id="year">1</div></div>
    <div class="stat"><div class="small">Time</div><div id="time">Day</div></div>
    <div style="flex:1"></div>
    <div id="tools" class="panel">
      <button class="btn" id="pauseBtn">‚èØÔ∏è</button>
      <button class="btn" id="faster">‚è©</button>
      <button class="btn" id="slower">‚è™</button>
      <select id="toolSelect" class="input" style="width:auto;margin-left:8px">
        <option value="select">Select</option>
        <option value="place">Place Building</option>
        <option value="spawn">Spawn Unit</option>
        <option value="smite">Smite</option>
      </select>
    </div>
  </div>
</div>
<div id="inspector" class="panel"></div>
<div id="customize">
  <div class="card panel">
    <h3>Aetheria ‚Äî Setup</h3>
    <div class="label">World Width / Height (tiles)</div>
    <input id="worldSize" class="input" type="number" value="80" />
    <div class="label">Race Preset</div>
    <select id="racePreset" class="input"><option value="expanded">Expanded</option><option value="all">All</option></select>
    <div class="label">Aggression</div>
    <select id="agg" class="input"><option value="low">Low</option><option value="med" selected>Medium</option><option value="high">High</option></select>
    <div style="height:8px"></div>
    <button id="start" class="btn">Start Simulation</button>
  </div>
</div>
<div id="toast" class="toast"></div>
<script>
/* ==========================
   CORE STATE & UTIL
   ========================== */
const canvas = document.getElementById('c'); const ctx = canvas.getContext('2d');
let STATE = { tiles:[], units:[], buildings:[], cities:[], kingdoms:[], mobs:[], time:{day:1,hour:12,year:1}, cam:{x:40,y:40,zoom:1}, gameSpeed:1, paused:false, tool:'select', selection:null };
let CONFIG = { worldSize:80, tile:18, aggression:'med' };
const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
const rnd = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const dist = (a,b)=>Math.hypot(a.x-b.x,a.y-b.y);
const toastEl = document.getElementById('toast');
function notify(t){ const d=document.createElement('div'); d.className='panel small'; d.textContent=t; toastEl.appendChild(d); setTimeout(()=>d.remove(),4000);} 

/* ==========================
   RACES (modular)
   ========================== */
let raceData = {
  Human:{icon:'üßë',lifespan:[60,90],fertility:0.12,aggression:0.12,crime:0.08,combat:1,preferred:['plains','forest']},
  Elf:{icon:'üßù',lifespan:[120,250],fertility:0.06,aggression:0.06,crime:0.03,combat:0.9,preferred:['forest']},
  Dwarf:{icon:'üßî',lifespan:[90,140],fertility:0.07,aggression:0.18,crime:0.05,combat:1.2,preferred:['mountain']},
  Orc:{icon:'üëπ',lifespan:[40,70],fertility:0.25,aggression:0.35,crime:0.18,combat:1.4,preferred:['plains']},
  Goblin:{icon:'üë∫',lifespan:[20,50],fertility:0.35,aggression:0.2,crime:0.3,combat:0.7,preferred:['plains','forest']},
  Vampire:{icon:'üßõ',lifespan:[999,999],fertility:0.01,aggression:0.25,crime:0.05,combat:1.6,preferred:['plains']}
};
let extra = {Troll:{icon:'üßü',lifespan:[80,120],fertility:0.04,aggression:0.4,crime:0.2,combat:1.6,preferred:['forest']},Halfling:{icon:'ü¶∂',lifespan:[60,90],fertility:0.15,aggression:0.03,crime:0.05,combat:0.6,preferred:['plains']},Gnome:{icon:'ü§è',lifespan:[60,110],fertility:0.12,aggression:0.04,crime:0.09,combat:0.7,preferred:['forest']}};

/* ==========================
   JOBS & BUILDINGS
   ========================== */
let jobData = { farmer:{income:1,produces:{food:1}}, miner:{income:2,produces:{stone:1}}, lumberjack:{income:1,produces:{wood:1}}, builder:{income:0.5,build:true}, soldier:{income:0.6,combat:1.2}, guard:{income:0.7,combat:1.1}, merchant:{income:1.4} };
let buildingData = {
  house:{icon:'üè†',cost:{wood:20,stone:5},capacity:3,produces:{}},
  farm:{icon:'üåæ',cost:{wood:12},produces:{food:4}},
  mine:{icon:'‚õèÔ∏è',cost:{wood:10,stone:20},produces:{stone:4}},
  sawmill:{icon:'ü™µ',cost:{wood:20},produces:{wood:6}},
  tavern:{icon:'üç∫',cost:{wood:25},produces:{happiness:2}},
  barracks:{icon:'üè∞',cost:{stone:40,wood:20},enables:'soldier'},
  market:{icon:'üè™',cost:{wood:20,stone:10}},
  prison:{icon:'üöì',cost:{stone:30},capacity:6}
};

/* ==========================
   MOBS
   ========================== */
let mobData = { deer:{icon:'ü¶å',passive:true,drop:{food:2}}, wolf:{icon:'üê∫',passive:false,aggression:0.35,drop:{food:3}}, bear:{icon:'üêª',passive:false,aggression:0.5,drop:{food:6}} };

/* ==========================
   WORLD GEN
   ========================== */
function generateWorld(n){ STATE.tiles=[]; for(let y=0;y<n;y++){ let row=[]; for(let x=0;x<n;x++){ let r=Math.random(); if(r<0.08) row.push('water'); else if(r<0.28) row.push('forest'); else if(r<0.38) row.push('mountain'); else row.push('plains'); } STATE.tiles.push(row);} }

/* ==========================
   SPAWN & UNIT
   ========================== */
let UID=1; function createUnit(opts){ const id=UID++; const u=Object.assign({id,age: rnd(16,30),hp:100,maxHp:100,money:10,home:null,job:null,traits:[],stress:0,crimeScore:0,inventory:{},mood:'neutral',alive:true},opts); STATE.units.push(u); return u; }

function spawnInitial(){ // create few cities and population
  // simple: place N cities at random spaced points
  const races=Object.keys(raceData);
  for(let i=0;i<4;i++){ const x=rnd(6,CONFIG.worldSize-6), y=rnd(6,CONFIG.worldSize-6); const race=races[i%races.length]; createCity(x,y,race); }
}

function createCity(x,y,raceName){ const id=Date.now()+Math.random(); const city={id,x,y,race:raceName,pop:0,resources:{wood:200,stone:150,food:300,gold:200},buildings:[],radius:6,level:'village'}; STATE.cities.push(city);
  // place a few houses and spawn population
  placeBuilding(city,x,y,'house'); placeBuilding(city,x+1,y,'farm'); placeBuilding(city,x-1,y,'tavern');
  for(let i=0;i<8;i++){ createUnit({race:raceName,x:x+Math.random()*3-1.5,y:y+Math.random()*3-1.5,home:city.id,job: ['farmer','lumberjack','miner','builder'][i%4] }); }
}

function placeBuilding(city,x,y,type){ // grid occupancy check
  const bx=Math.floor(x), by=Math.floor(y); const size=CONFIG.worldSize; if(bx<0||by<0||bx>=size||by>=size) return false; // can't place on water/mountain
  if(STATE.tiles[by][bx]==='water' || STATE.tiles[by][bx]==='mountain') return false; // existing building collision
  if(STATE.buildings.find(b=>b.x===bx && b.y===by)) return false; // occupancy
  const bdef=buildingData[type]; if(!bdef) return false;
  // pay cost
  const cityObj = STATE.cities.find(c=>c.id===city);
  if(!cityObj) return false;
  for(const res in (bdef.cost||{})){ if((cityObj.resources[res]||0) < bdef.cost[res]) return false; }
  for(const res in (bdef.cost||{})){ cityObj.resources[res]-=bdef.cost[res]; }
  const b={id:Date.now()+Math.random(),x:bx,y:by,type,city:city,level:1,residents:[],capacity:bdef.capacity||0}; STATE.buildings.push(b); cityObj.buildings.push(b.id);
  return true;
}

/* ==========================
   SIM: JOB TICK, ECONOMY, BUILDING UPKEEP
   ========================== */
function tickEconomy(){ // each worker at job produces and earns
  for(const u of STATE.units){ if(!u.alive) continue; if(!u.job) continue; const jd = jobData[u.job]; if(!jd) continue; // produce to city
    const city=STATE.cities.find(c=>c.id===u.home); if(city){ // income
      u.money += jd.income; city.resources.gold = (city.resources.gold||0); city.resources.gold += 0; // city gold not used yet
      for(const p in (jd.produces||{})){ city.resources[p] = (city.resources[p]||0) + jd.produces[p]; }
    }
  }
}

/* ==========================
   PERSONALITY / MOODS / STRESS / DISEASES
   ========================== */
const personalities=['calm','anxious','industrious','lazy','greedy','loyal'];
function seedPersonality(u){ if(!u.personality) u.personality = personalities[Math.floor(Math.random()*personalities.length)]; }
function updateMoods(){ for(const u of STATE.units){ if(!u.alive) continue; seedPersonality(u); // stress fluctuates
    u.stress = clamp((u.stress + (Math.random()-0.45)*0.2),0,100);
    // stress affects mood
    if(u.stress>70) u.mood='stressed'; else if(u.stress>40) u.mood='uneasy'; else u.mood='content';
    // crime score influenced by personality and stress
    u.crimeScore = (u.traits.includes('criminal')?0.3:0) + (u.personality==='greedy'?0.15:0) + (u.stress/200);
  }
}

/* ==========================
   CRIME: theft & punishment
   ========================== */
function attemptCrime(u){ if(u.crimeScore < 0.08) return; if(u.cooldown>0) return; // find victim in same city
  const victims = STATE.units.filter(v=>v.home===u.home && v.id!==u.id && v.alive && v.money>5 && dist(u,v)<3);
  if(victims.length===0) return; const v=victims[Math.floor(Math.random()*victims.length)]; const steal = Math.min(v.money, Math.floor(1+Math.random()*5)); v.money-=steal; u.money+=steal; u.stress -=5; u.cooldown = 60; notify(`${u.race} stole ${steal} gold from ${v.race}`);
  // chance to be caught based on guard presence
  const city=STATE.cities.find(c=>c.id===u.home); if(city){ const guards = STATE.units.filter(g=>g.home===city.id && g.job==='guard'); if(guards.length>0 && Math.random()<0.3){ // caught
      u.traits.push('arrested'); u.alive=true; // move to prison (simple: remove for time)
      u.cooldown = 300; notify(`${u.race} was caught stealing and jailed`);
    } }
}

/* ==========================
   COMBAT & MOBS
   ========================== */
function mobBehavior(){ for(const m of STATE.mobs){ if(!m.alive) continue; // simple roam
    m.x = clamp(m.x + (Math.random()*3-1),0,CONFIG.worldSize-1); m.y = clamp(m.y + (Math.random()*3-1),0,CONFIG.worldSize-1);
    if(!m.passive){ // attack nearby units
      const targets = STATE.units.filter(u=>u.alive && dist(u,m)<3);
      if(targets.length>0){ const t=targets[Math.floor(Math.random()*targets.length)]; // fight
          const dmg = Math.floor((m.aggression||0.3)*30); t.hp -= dmg; if(t.hp<=0){ t.alive=false; notify(`${t.race} was killed by ${m.type}`); }
      }
    }
  } }

function unitCombat(){ // units attack mobs or other enemies when aggressive
  for(const u of STATE.units){ if(!u.alive) continue; if(u.job==='soldier' || u.job==='guard'){ // seek nearby mobs or hostile units
      const mobsNearby = STATE.mobs.filter(m=>m.alive && dist(m,u)<3);
      if(mobsNearby.length>0){ const m=mobsNearby[0]; m.hp = (m.hp||50) - Math.floor(10 * (1 + (u.race && raceData[u.race]?.combat||1))); if(m.hp<=0){ m.alive=false; // loot
            const city=STATE.cities.find(c=>c.id===u.home); if(city){ city.resources.food = (city.resources.food||0) + (m.drop?.food||1); }
            notify(`${u.race} killed a ${m.type}`);
          }
      }
    }
  }
}

/* ==========================
   CITY & KINGDOM Logic
   ========================== */
function updateCities(){ for(const c of STATE.cities){ c.pop = STATE.units.filter(u=>u.home===c.id && u.alive).length; // level up
    if(c.pop>30) c.level='city'; else if(c.pop>12) c.level='town'; else c.level='village';
    // resources used to build
    if(c.pop > c.radius*1.5 && Math.random()<0.02){ c.radius+=1; }
    // assign capital/kingdom if big
    if(c.level==='city' && !STATE.kingdoms.find(k=>k.capital===c.id)){ const k={id:Date.now()+Math.random(),capital:c.id,ruler:null,treasury:{wood:100,stone:100,food:200}}; STATE.kingdoms.push(k); c.kingdom = k.id; notify(`A new kingdom formed around ${c.race} city`); assignRuler(k,c); }
  } }

function assignRuler(k,c){ // pick a unit from city
  const candidates = STATE.units.filter(u=>u.home===c.id && u.alive);
  if(candidates.length===0) return; const ruler=candidates[Math.floor(Math.random()*candidates.length)]; k.ruler = ruler.id; ruler.title = 'King/Queen'; notify(`${ruler.race} became ruler of a kingdom`);
}

/* ==========================
   TICKS & LOOP
   ========================== */
function gameTick(){ if(STATE.paused) return; // time
  STATE.time.hour += 0.25*STATE.gameSpeed; if(STATE.time.hour>=24){ STATE.time.hour=0; STATE.time.day++; document.getElementById('year').innerText = Math.floor(STATE.time.day/365)+1; }
  // each tick: economy, moods, crime, mobs, combat
  tickEconomy(); updateMoods(); for(const u of STATE.units){ attemptCrime(u); }
  mobBehavior(); unitCombat(); updateCities(); render(); }

setInterval(gameTick, 180);

/* ==========================
   RENDER
   ========================== */
function resize(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resize); resize();

function render(){ ctx.fillStyle='#071018'; ctx.fillRect(0,0,canvas.width,canvas.height);
  const size = CONFIG.worldSize; const tsize = CONFIG.tile; // center camera
  const ox = canvas.width/2 - STATE.cam.x*tsize*STATE.cam.zoom; const oy = canvas.height/2 - STATE.cam.y*tsize*STATE.cam.zoom; ctx.save(); ctx.translate(ox,oy); ctx.scale(STATE.cam.zoom,STATE.cam.zoom);
  // tiles
  for(let y=0;y<size;y++){ for(let x=0;x<size;x++){ const tile=STATE.tiles[y][x]; if(tile==='water') ctx.fillStyle='#163a5b'; else if(tile==='forest') ctx.fillStyle='#1f5f3e'; else if(tile==='mountain') ctx.fillStyle='#5a5a5a'; else ctx.fillStyle='#2b2f36'; ctx.fillRect(x*tsize,y*tsize,tsize,tsize); } }
  // buildings
  for(const b of STATE.buildings){ const def=buildingData[b.type]; ctx.font=(tsize-2)+'px serif'; ctx.fillText(def.icon, b.x*tsize+2, b.y*tsize+tsize-4); }
  // mobs
  for(const m of STATE.mobs){ if(!m.alive) continue; ctx.font=(tsize-2)+'px serif'; ctx.fillText(m.icon, Math.floor(m.x)*tsize+2, Math.floor(m.y)*tsize+tsize-4); }
  // units
  for(const u of STATE.units){ if(!u.alive) continue; ctx.font=(tsize-2)+'px serif'; const icon = raceData[u.race]?.icon||'?'; ctx.fillText(icon, Math.floor(u.x)*tsize+2, Math.floor(u.y)*tsize+tsize-4); }
  ctx.restore();
}

/* ==========================
   INPUT / UI
   ========================== */
document.getElementById('pauseBtn').onclick = ()=>{ STATE.paused = !STATE.paused; document.getElementById('pauseBtn').textContent = STATE.paused? '‚ñ∂Ô∏è' : '‚èØÔ∏è'; };
document.getElementById('faster').onclick = ()=>{ STATE.gameSpeed = Math.min(8, STATE.gameSpeed*2); notify('Speed x'+STATE.gameSpeed); };
document.getElementById('slower').onclick = ()=>{ STATE.gameSpeed = Math.max(0.25, STATE.gameSpeed/2); notify('Speed x'+STATE.gameSpeed); };
document.getElementById('toolSelect').onchange = (e)=>{ STATE.tool = e.target.value; };

canvas.addEventListener('click', (ev)=>{ const rect=canvas.getBoundingClientRect(); const mx=ev.clientX-rect.left; const my=ev.clientY-rect.top; const size=CONFIG.tile; const ox = canvas.width/2 - STATE.cam.x*size*STATE.cam.zoom; const oy = canvas.height/2 - STATE.cam.y*size*STATE.cam.zoom; const gx = Math.floor((mx-ox)/ (size*STATE.cam.zoom)); const gy = Math.floor((my-oy)/ (size*STATE.cam.zoom)); if(gx<0||gy<0||gx>=CONFIG.worldSize||gy>=CONFIG.worldSize) return;
  if(STATE.tool==='place'){ // place building near selection city
    const city = STATE.cities[0]; // simple: first city
    if(placeBuilding(city.id,gx,gy,'house')) notify('Placed a house'); else notify('Cannot place here');
  } else if(STATE.tool==='spawn'){ createUnit({race: 'Human', x:gx, y:gy, home: STATE.cities[0].id}); notify('Spawned unit'); }
  else if(STATE.tool==='smite'){ // kill units/mobs nearby
    const targets = STATE.units.filter(u=>dist(u,{x:gx,y:gy})<2); for(const t of targets){ t.alive=false; notify('Smite killed a unit'); }
  }
});

/* ==========================
   INITIALIZATION
   ========================== */
function initFromUI(){ CONFIG.worldSize = parseInt(document.getElementById('worldSize').value); const rp = document.getElementById('racePreset').value; if(rp==='expanded'){ Object.assign(raceData, extra); } if(document.getElementById('agg').value==='low'){ for(const r in raceData) raceData[r].aggression *= 0.5; } else if(document.getElementById('agg').value==='high'){ for(const r in raceData) raceData[r].aggression *= 1.5; }
  generateWorld(CONFIG.worldSize);
  // spawn mobs
  for(let i=0;i<40;i++){ const t=Object.keys(mobData)[Math.floor(Math.random()*Object.keys(mobData).length)]; STATE.mobs.push({type:t,icon:mobData[t].icon,x:Math.random()*CONFIG.worldSize,y:Math.random()*CONFIG.worldSize,alive:true,passive:mobData[t].passive,aggression:mobData[t].aggression,drop:mobData[t].drop}); }
  spawnInitial(); document.getElementById('customize').style.display='none';
}

document.getElementById('start').onclick = initFromUI;

/* ==========================
   QUICK HELP / TEST ACTIONS
   ========================== */
function notify(msg){ try{ notifyRaw(msg); }catch(e){ console.log(msg); } }
function notifyRaw(msg){ const el=document.createElement('div'); el.className='panel small'; el.textContent=msg; document.getElementById('toast').appendChild(el); setTimeout(()=>el.remove(),4000); }

// start render loop
setInterval(render,100);
</script>
</body>
</html>
