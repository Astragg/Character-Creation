<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>High Noon Duel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rye&family=VT323&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Rye', serif;
            background-color: #2c241b;
            color: #f3e5ab;
            overflow: hidden;
            touch-action: manipulation;
        }
        .pixel-font { font-family: 'VT323', monospace; }
        .wood-texture {
            background-color: #5d4037;
            background-image: repeating-linear-gradient(45deg, #4e342e 25%, transparent 25%, transparent 75%, #4e342e 75%, #4e342e), repeating-linear-gradient(45deg, #4e342e 25%, #5d4037 25%, #5d4037 75%, #4e342e 75%, #4e342e);
            background-position: 0 0, 10px 10px;
            background-size: 20px 20px;
        }
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .flash { animation: flash 0.2s ease-out; }
        @keyframes flash {
            0% { background-color: white; }
            100% { background-color: transparent; }
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #2c241b; }
        ::-webkit-scrollbar-thumb { background: #8d6e63; border-radius: 4px; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col items-center justify-center relative">

    <div class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none z-0" style="background-image: url('data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'none\' fill-rule=\'evenodd\'%3E%3Cg fill=\'%239C92AC\' fill-opacity=\'0.4\'%3E%3Cpath d=\'M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');"></div>

    <div id="app" class="w-full max-w-md h-full max-h-[800px] flex flex-col relative z-10">
        
        <header class="w-full p-4 flex justify-between items-center bg-amber-900/80 border-b-4 border-amber-950 shadow-lg">
            <h1 class="text-2xl tracking-wider text-amber-200 drop-shadow-md">HIGH NOON</h1>
            <div id="user-badge" class="text-xs pixel-font bg-black/50 px-2 py-1 rounded text-amber-400">Loading...</div>
        </header>

        <main class="flex-1 relative overflow-hidden flex flex-col">
            
            <!-- View: Login -->
            <div id="view-login" class="absolute inset-0 flex flex-col items-center justify-center p-6 bg-black/40 backdrop-blur-sm">
                <div class="wood-texture p-8 rounded-lg border-4 border-amber-800 shadow-2xl text-center w-full">
                    <div class="mb-6 text-6xl">ü§†</div>
                    <h2 class="text-xl mb-4 text-amber-100">Enter Your Name, Partner</h2>
                    <input type="text" id="username-input" maxlength="10" placeholder="Billy The Kid" 
                           class="w-full bg-amber-100 text-amber-900 px-4 py-3 rounded border-2 border-amber-900 font-bold text-center mb-4 focus:outline-none focus:ring-4 focus:ring-amber-600 placeholder-amber-900/50">
                    <button id="btn-enter" class="w-full bg-red-700 hover:bg-red-600 text-white py-3 rounded border-b-4 border-red-900 active:border-b-0 active:translate-y-1 transition-all font-bold tracking-widest">
                        ENTER SALOON
                    </button>
                </div>
            </div>

            <!-- View: Lobby -->
            <div id="view-lobby" class="absolute inset-0 flex flex-col p-4 hidden">
                <div class="flex justify-between items-end mb-4">
                    <h2 class="text-xl text-amber-400 border-b-2 border-amber-400 pb-1">WANTED POSTERS</h2>
                    <button id="btn-refresh" class="text-sm text-amber-200 underline cursor-pointer">Refresh</button>
                </div>
                
                <div id="game-list" class="flex-1 overflow-y-auto space-y-3 mb-4 p-2">
                    <div class="text-center opacity-50 mt-10 pixel-font text-lg">Searching for open duels...</div>
                </div>

                <button id="btn-create" class="w-full bg-amber-600 hover:bg-amber-500 text-white py-4 rounded border-b-4 border-amber-800 active:border-b-0 active:translate-y-1 transition-all font-bold tracking-widest shadow-lg text-xl">
                    CREATE NEW DUEL
                </button>
            </div>

            <!-- View: Waiting -->
            <div id="view-waiting" class="absolute inset-0 flex flex-col items-center justify-center p-6 hidden">
                <div class="text-center animate-pulse">
                    <h2 class="text-3xl mb-2">WAITING FOR OPPONENT...</h2>
                    <p class="text-amber-400 pixel-font text-xl">Polishing revolver...</p>
                </div>
                <div class="mt-12 p-4 bg-black/30 rounded border border-amber-700 text-center">
                    <p class="text-xs text-gray-400 mb-1">SHARE CODE (Optional)</p>
                    <p id="waiting-code" class="text-xl font-mono select-all cursor-pointer text-white">---</p>
                </div>
                <button id="btn-cancel-game" class="mt-8 text-red-400 hover:text-red-300 underline">Cancel Duel</button>
            </div>

            <!-- View: Game -->
            <div id="view-game" class="absolute inset-0 flex flex-col hidden bg-black">
                <div class="h-16 bg-stone-900 flex justify-between items-center px-4 border-b border-stone-700">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></div>
                        <span id="game-status-text" class="pixel-font text-xl text-green-400">CONNECTED</span>
                    </div>
                    <div class="text-xs text-stone-500">VS: <span id="opponent-name" class="text-stone-300 font-bold">???</span></div>
                </div>

                <div id="duel-area" class="flex-1 relative flex flex-col items-center justify-center cursor-crosshair select-none active:bg-stone-900 transition-colors">
                    <div id="center-display" class="text-center z-20 pointer-events-none">
                        <h1 id="main-message" class="text-6xl md:text-8xl text-stone-500 font-black tracking-tighter transition-all">READY...</h1>
                        <p id="sub-message" class="text-xl text-stone-600 mt-2 pixel-font">Don't shoot yet!</p>
                    </div>

                    <div class="absolute bottom-0 left-1/2 transform -translate-x-1/2 mb-4 transition-transform duration-100" id="my-avatar">
                         <svg width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="#f3e5ab" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="8" r="5" />
                            <path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
                            <path d="M16 11l2 2l4 -4" />
                        </svg>
                    </div>

                    <div class="absolute top-0 left-1/2 transform -translate-x-1/2 mt-20 opacity-50 grayscale transition-all duration-300" id="opponent-avatar">
                        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="8" r="5" />
                            <path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
                            <path d="M16 11l2 2l4 -4" />
                        </svg>
                    </div>

                    <div id="gunshot-fx" class="absolute inset-0 bg-white opacity-0 pointer-events-none"></div>
                </div>

                <div id="result-overlay" class="absolute inset-0 bg-black/90 z-50 flex flex-col items-center justify-center hidden">
                    <div id="result-emoji" class="text-8xl mb-4">üíÄ</div>
                    <h2 id="result-title" class="text-5xl text-red-500 mb-2">YOU DIED</h2>
                    <p id="result-subtitle" class="text-stone-400 mb-8 pixel-font">Opponent was 0.02s faster</p>
                    <button id="btn-leave-game" class="bg-stone-700 hover:bg-stone-600 px-8 py-3 rounded text-white font-bold border-b-4 border-stone-900">
                        BACK TO TOWN
                    </button>
                </div>
            </div>

        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, updateDoc, onSnapshot, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // --------------------------------------------------------------
        // 1. PASTE YOUR FIREBASE CONFIGURATION HERE
        // --------------------------------------------------------------
const firebaseConfig = {
  apiKey: "AIzaSyDCrKQVcGBW4iy7OMAtn4Jcf1ot5CGALBE",
  authDomain: "highnoon-66ee0.firebaseapp.com",
  databaseURL: "https://highnoon-66ee0-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "highnoon-66ee0",
  storageBucket: "highnoon-66ee0.firebasestorage.app",
  messagingSenderId: "754268761672",
  appId: "1:754268761672:web:7fbf59d2c403b43356727d"
};
        // --------------------------------------------------------------

        // Fallback if config is missing to prevent crash on load
        if (Object.keys(firebaseConfig).length === 0) {
            alert("‚ö†Ô∏è You must paste your Firebase Config in the code! Open index.html and look for the 'firebaseConfig' variable.");
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // We used to use a deep path for the demo environment, but for your own GitHub pages,
        // we can use a simpler collection name at the root level.
        const GAMES_COLLECTION = "high_noon_duels";
        
        let currentUser = null;
        let currentUserName = localStorage.getItem('cowboyName') || '';
        let currentGameId = null;
        let gameUnsubscribe = null;
        let myRole = null; 
        let gameState = 'menu'; 
        let canShoot = false;

        const views = {
            login: document.getElementById('view-login'),
            lobby: document.getElementById('view-lobby'),
            waiting: document.getElementById('view-waiting'),
            game: document.getElementById('view-game')
        };
        const inputs = { name: document.getElementById('username-input') };
        const ui = {
            badge: document.getElementById('user-badge'),
            gameList: document.getElementById('game-list'),
            waitingCode: document.getElementById('waiting-code'),
            mainMsg: document.getElementById('main-message'),
            subMsg: document.getElementById('sub-message'),
            duelArea: document.getElementById('duel-area'),
            resultOverlay: document.getElementById('result-overlay'),
            resultTitle: document.getElementById('result-title'),
            resultSub: document.getElementById('result-subtitle'),
            resultEmoji: document.getElementById('result-emoji'),
            opponentName: document.getElementById('opponent-name'),
            gunshot: document.getElementById('gunshot-fx')
        };

        // Sound Logic
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (type === 'click') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'shoot') {
                const bufferSize = audioCtx.sampleRate * 0.5;
                const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) { data[i] = Math.random() * 2 - 1; }
                const noise = audioCtx.createBufferSource();
                noise.buffer = buffer;
                noise.connect(gain);
                gain.gain.setValueAtTime(1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                noise.start();
            } else if (type === 'win') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(440, audioCtx.currentTime);
                osc.frequency.setValueAtTime(554, audioCtx.currentTime + 0.1); 
                osc.frequency.setValueAtTime(659, audioCtx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.6);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.6);
            }
        }

        // Auth Logic - Simplified for Static Hosting
        signInAnonymously(auth).catch(console.error);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                ui.badge.textContent = "ID: " + user.uid.slice(0, 4);
                if (currentUserName) {
                    inputs.name.value = currentUserName;
                    showView('lobby');
                    refreshGameList();
                } else {
                    showView('login');
                }
            }
        });

        // DOM Events
        function showView(viewName) {
            Object.values(views).forEach(el => el.classList.add('hidden'));
            views[viewName].classList.remove('hidden');
            gameState = viewName;
        }

        document.getElementById('btn-enter').addEventListener('click', () => {
            const name = inputs.name.value.trim();
            if (!name) return;
            currentUserName = name;
            localStorage.setItem('cowboyName', name);
            playSound('click');
            showView('lobby');
            refreshGameList();
        });

        document.getElementById('btn-create').addEventListener('click', createGame);
        document.getElementById('btn-refresh').addEventListener('click', () => {
            playSound('click');
            refreshGameList();
        });
        document.getElementById('btn-cancel-game').addEventListener('click', leaveGame);
        document.getElementById('btn-leave-game').addEventListener('click', leaveGame);

        // Game Functions
        async function refreshGameList() {
            ui.gameList.innerHTML = '<div class="text-center opacity-50 pixel-font">Scouting the plains...</div>';
            try {
                const gamesRef = collection(db, GAMES_COLLECTION);
                const snapshot = await getDocs(gamesRef);
                
                ui.gameList.innerHTML = '';
                let found = false;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.status === 'waiting' && data.host !== currentUser.uid) {
                        found = true;
                        const el = document.createElement('div');
                        el.className = 'bg-amber-900/40 border border-amber-700 p-3 rounded flex justify-between items-center cursor-pointer hover:bg-amber-800/50 transition-colors';
                        el.innerHTML = `
                            <div>
                                <div class="font-bold text-amber-200">${data.hostName || 'Unknown Cowboy'}</div>
                                <div class="text-xs text-amber-500 pixel-font">Status: Waiting</div>
                            </div>
                            <button class="bg-amber-600 text-white px-3 py-1 rounded text-sm shadow">JOIN</button>
                        `;
                        el.onclick = () => joinGame(doc.id, data);
                        ui.gameList.appendChild(el);
                    }
                });

                if (!found) {
                    ui.gameList.innerHTML = '<div class="text-center opacity-50 mt-4 pixel-font">No open duels found.<br>Start your own!</div>';
                }
            } catch (err) {
                console.error(err);
                ui.gameList.innerText = "Error loading saloon data. Did you add your API Key?";
            }
        }

        async function createGame() {
            playSound('click');
            try {
                const newId = doc(collection(db, GAMES_COLLECTION)).id;
                await setDoc(doc(db, GAMES_COLLECTION, newId), {
                    host: currentUser.uid,
                    hostName: currentUserName,
                    status: 'waiting',
                    createdAt: Date.now()
                });
                
                currentGameId = newId;
                myRole = 'host';
                ui.waitingCode.textContent = currentGameId;
                showView('waiting');
                subscribeToGame(currentGameId);
            } catch (e) { console.error(e); }
        }

        async function joinGame(gameId, gameData) {
            playSound('click');
            try {
                await updateDoc(doc(db, GAMES_COLLECTION, gameId), {
                    joiner: currentUser.uid,
                    joinerName: currentUserName,
                    status: 'ready'
                });
                currentGameId = gameId;
                myRole = 'joiner';
                subscribeToGame(gameId);
            } catch (e) { console.error(e); }
        }

        function subscribeToGame(gameId) {
            if (gameUnsubscribe) gameUnsubscribe();
            gameUnsubscribe = onSnapshot(doc(db, GAMES_COLLECTION, gameId), (docSnap) => {
                if (!docSnap.exists()) { leaveGame(); return; }
                handleGameState(docSnap.data());
            });
        }

        function handleGameState(data) {
            if (data.status === 'waiting') {
                if (gameState !== 'waiting' && myRole === 'host') showView('waiting');
                return;
            }

            if (gameState !== 'game' && (data.status === 'ready' || data.status === 'counting' || data.status === 'draw')) {
                showView('game');
                const oppName = myRole === 'host' ? data.joinerName : data.hostName;
                ui.opponentName.textContent = oppName;
                if (myRole === 'host' && data.status === 'ready') startCountdownSequence();
            }

            if (data.status === 'counting') {
                ui.mainMsg.textContent = "STEADY...";
                ui.mainMsg.className = "text-6xl md:text-8xl text-amber-600 font-black tracking-tighter animate-pulse";
                ui.subMsg.textContent = "Wait for the signal...";
                ui.duelArea.classList.remove('cursor-crosshair');
                ui.duelArea.classList.add('cursor-not-allowed');
                canShoot = false;
            } else if (data.status === 'draw') {
                if (!canShoot && !data.winner) {
                    ui.mainMsg.textContent = "DRAW!";
                    ui.mainMsg.className = "text-8xl md:text-9xl text-red-600 font-black tracking-widest shake";
                    ui.subMsg.textContent = "FIRE!";
                    ui.duelArea.classList.add('cursor-crosshair');
                    ui.duelArea.classList.remove('cursor-not-allowed');
                    ui.gunshot.classList.add('flash');
                    setTimeout(() => ui.gunshot.classList.remove('flash'), 200);
                    canShoot = true;
                }
            }

            if (data.winner) {
                canShoot = false;
                ui.resultOverlay.classList.remove('hidden');
                if (data.winner === currentUser.uid) {
                    playSound('win');
                    ui.resultEmoji.textContent = "ü§†";
                    ui.resultTitle.textContent = "VICTORY";
                    ui.resultTitle.className = "text-5xl text-amber-400 mb-2";
                    ui.resultSub.textContent = "You are the fastest hand in the West.";
                } else {
                    ui.resultEmoji.textContent = "üíÄ";
                    ui.resultTitle.textContent = "WASTED";
                    ui.resultTitle.className = "text-5xl text-red-600 mb-2";
                    ui.resultSub.textContent = "Better luck next time, partner.";
                }
            }
        }

        async function startCountdownSequence() {
            const gameRef = doc(db, GAMES_COLLECTION, currentGameId);
            await updateDoc(gameRef, { status: 'counting' });
            const delay = 2000 + Math.random() * 4000;
            setTimeout(async () => {
                await updateDoc(gameRef, { status: 'draw', drawTimestamp: Date.now() });
            }, delay);
        }

        ui.duelArea.addEventListener('mousedown', handleShoot); 
        ui.duelArea.addEventListener('touchstart', handleShoot);

        async function handleShoot(e) {
            if(e.type === 'touchstart') e.preventDefault();
            if (!canShoot) {
                if (gameState === 'game' && ui.mainMsg.textContent === "STEADY...") {
                    ui.mainMsg.classList.add('shake');
                    setTimeout(() => ui.mainMsg.classList.remove('shake'), 500);
                }
                return;
            }
            canShoot = false;
            playSound('shoot');
            ui.gunshot.classList.add('flash');
            try {
                await updateDoc(doc(db, GAMES_COLLECTION, currentGameId), { winner: currentUser.uid });
            } catch (err) { console.log(err); }
        }

        async function leaveGame() {
            if (gameUnsubscribe) gameUnsubscribe();
            ui.resultOverlay.classList.add('hidden');
            if (currentGameId && myRole === 'host') {
                try { await deleteDoc(doc(db, GAMES_COLLECTION, currentGameId)); } catch (e) {}
            }
            currentGameId = null;
            myRole = null;
            showView('lobby');
            refreshGameList();
        }

        window.oncontextmenu = (e) => { e.preventDefault(); return false; };
    </script>
</body>
</html>
