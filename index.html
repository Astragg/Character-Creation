<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBA Draft Battles</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Teko:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Teko', sans-serif;
            background-color: #0f172a;
            color: white;
        }
        
        .nba-card {
            transition: all 0.2s;
            background: linear-gradient(145deg, #1e293b, #0f172a);
        }
        .nba-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        .nba-card.disabled {
            opacity: 0.4;
            pointer-events: none;
            filter: grayscale(100%);
        }
        .nba-card.selected {
            border: 2px solid #3b82f6;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #334155; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569; 
        }

        .shiny-text {
            background: linear-gradient(to right, #fff, #94a3b8, #fff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            background-size: 200% auto;
            animation: shine 3s linear infinite;
        }
        @keyframes shine {
            to {
                background-position: 200% center;
            }
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Modal for Alerts -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-gray-800 p-6 rounded-lg max-w-sm w-full border border-gray-700 shadow-2xl transform transition-all scale-100">
            <h3 id="modal-title" class="text-2xl font-bold mb-2 text-red-400">Error</h3>
            <p id="modal-msg" class="text-gray-300 text-lg mb-6">Message goes here</p>
            <button onclick="closeModal()" class="w-full py-2 bg-red-600 hover:bg-red-700 text-white rounded uppercase tracking-wider font-bold">Close</button>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-gray-900 border-b border-gray-800 p-4 flex justify-between items-center shrink-0">
        <div class="flex items-center gap-2">
            <i class="fas fa-basketball-ball text-orange-500 text-2xl"></i>
            <h1 class="text-3xl font-bold tracking-widest uppercase shiny-text">Draft Battles</h1>
        </div>
        <div id="user-info" class="text-gray-400 text-lg">Connecting...</div>
    </header>

    <!-- App Container -->
    <main id="app-container" class="flex-1 overflow-hidden relative">
        
        <!-- VIEW: LOBBY -->
        <div id="view-lobby" class="absolute inset-0 flex flex-col items-center justify-center p-4">
            <div class="max-w-md w-full space-y-8 text-center">
                <div class="bg-gray-800 p-8 rounded-xl border border-gray-700 shadow-2xl">
                    <h2 class="text-4xl font-bold mb-6 text-white">Enter The Court</h2>
                    
                    <div class="space-y-4">
                        <button onclick="createRoom()" class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold text-xl uppercase tracking-widest transition shadow-lg shadow-blue-900/50">
                            Create New Lobby
                        </button>
                        
                        <div class="relative flex py-2 items-center">
                            <div class="flex-grow border-t border-gray-600"></div>
                            <span class="flex-shrink-0 mx-4 text-gray-500 text-lg">OR JOIN</span>
                            <div class="flex-grow border-t border-gray-600"></div>
                        </div>

                        <div class="flex gap-2">
                            <input type="text" id="room-input" placeholder="Enter Room ID" class="flex-1 bg-gray-900 border border-gray-600 text-white px-4 py-3 rounded-lg focus:outline-none focus:border-blue-500 text-lg uppercase">
                            <button onclick="joinRoom()" class="bg-green-600 hover:bg-green-500 text-white px-6 py-3 rounded-lg font-bold uppercase tracking-wide">
                                Join
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="text-gray-500 text-lg">
                    <p>Challenge a friend to a fantasy draft.</p>
                    <p>Select modes like "1 Star, 4 Role Players".</p>
                </div>
            </div>
        </div>

        <!-- VIEW: LOBBY WAITING -->
        <div id="view-waiting" class="absolute inset-0 flex flex-col items-center justify-center p-4 hidden bg-gray-900/95 z-10">
            <div class="bg-gray-800 p-8 rounded-xl border border-gray-700 shadow-2xl text-center max-w-lg w-full">
                <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-orange-500 mx-auto mb-6"></div>
                <h2 class="text-3xl font-bold mb-2">Lobby Created</h2>
                <p class="text-gray-400 text-xl mb-6">Share this ID with your opponent:</p>
                
                <div class="flex items-center gap-2 bg-gray-900 p-4 rounded-lg border border-gray-600 mb-6 group cursor-pointer" onclick="copyRoomId()">
                    <code id="display-room-id" class="text-3xl text-blue-400 font-mono tracking-widest flex-1">...</code>
                    <i class="fas fa-copy text-gray-500 group-hover:text-white transition"></i>
                </div>

                <div class="text-left bg-gray-900/50 p-4 rounded mb-6">
                    <label class="block text-gray-400 mb-2 uppercase tracking-wide">Select Game Mode:</label>
                    <select id="mode-select" onchange="updateGameMode()" class="w-full bg-gray-800 border border-gray-600 text-white p-2 rounded text-xl">
                        <option value="classic">Classic (Best 5)</option>
                        <option value="ringless">1 King & 4 Pawns (Max 1 Ring/Star)</option>
                    </select>
                    <p id="mode-desc" class="text-sm text-gray-500 mt-2">Draft any 5 players. Highest total rating wins.</p>
                </div>

                <p class="text-yellow-500 animate-pulse text-lg uppercase tracking-widest">Waiting for opponent...</p>
            </div>
        </div>

        <!-- VIEW: DRAFT BOARD -->
        <div id="view-draft" class="absolute inset-0 flex flex-col hidden">
            <!-- Game Status Bar -->
            <div class="bg-gray-800 border-b border-gray-700 p-2 flex justify-between items-center shrink-0 shadow-lg z-20">
                <div class="flex items-center gap-4">
                    <div class="px-3 py-1 bg-gray-700 rounded text-lg">
                        Mode: <span id="game-mode-display" class="text-blue-400 font-bold">Classic</span>
                    </div>
                    <div id="turn-indicator" class="px-4 py-1 bg-orange-600 text-white font-bold rounded text-xl uppercase animate-pulse shadow-lg shadow-orange-900/50">
                        Loading...
                    </div>
                </div>
                <div class="text-xl font-mono text-gray-400">
                    Room: <span id="draft-room-id"></span>
                </div>
            </div>

            <!-- Main Draft Area -->
            <div class="flex-1 flex overflow-hidden">
                <!-- Team 1 (Host) -->
                <div class="w-1/4 bg-gray-900 border-r border-gray-800 flex flex-col">
                    <div class="p-3 bg-gray-800 border-b border-gray-700">
                        <h3 class="text-2xl font-bold text-blue-400 text-center uppercase tracking-widest">Team Host</h3>
                        <div id="host-score" class="text-center text-gray-400 text-lg">Rating: 0</div>
                    </div>
                    <div id="roster-host" class="flex-1 overflow-y-auto p-2 space-y-2">
                        <!-- Host Slots -->
                    </div>
                </div>

                <!-- Player Pool -->
                <div class="w-2/4 bg-gray-900 flex flex-col">
                    <div class="p-3 bg-gray-800 border-b border-gray-700 flex gap-2">
                        <input type="text" id="player-search" placeholder="Search Players..." class="flex-1 bg-gray-900 border border-gray-600 text-white px-3 py-1 rounded text-lg focus:outline-none focus:border-blue-500">
                        <select id="pos-filter" class="bg-gray-900 border border-gray-600 text-white px-3 py-1 rounded text-lg">
                            <option value="ALL">All</option>
                            <option value="G">Guards</option>
                            <option value="F">Forwards</option>
                            <option value="C">Centers</option>
                        </select>
                    </div>
                    
                    <div id="player-pool" class="flex-1 overflow-y-auto p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 content-start">
                        <!-- Player Cards -->
                    </div>
                </div>

                <!-- Team 2 (Guest) -->
                <div class="w-1/4 bg-gray-900 border-l border-gray-800 flex flex-col">
                    <div class="p-3 bg-gray-800 border-b border-gray-700">
                        <h3 class="text-2xl font-bold text-red-400 text-center uppercase tracking-widest">Team Guest</h3>
                        <div id="guest-score" class="text-center text-gray-400 text-lg">Rating: 0</div>
                    </div>
                    <div id="roster-guest" class="flex-1 overflow-y-auto p-2 space-y-2">
                        <!-- Guest Slots -->
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: GAME OVER -->
        <div id="view-result" class="absolute inset-0 flex flex-col items-center justify-center p-4 hidden bg-black/90 z-30">
            <div class="bg-gray-800 p-10 rounded-xl border-2 border-yellow-500 shadow-2xl text-center max-w-2xl w-full">
                <h2 class="text-6xl font-bold mb-4 text-yellow-500 uppercase tracking-widest">Draft Complete</h2>
                
                <div class="flex justify-center items-end gap-8 mb-8">
                    <div class="text-center">
                        <div class="text-2xl text-blue-400 mb-1">HOST</div>
                        <div id="final-score-host" class="text-5xl font-bold text-white">0</div>
                    </div>
                    <div class="text-4xl text-gray-600 font-bold">VS</div>
                    <div class="text-center">
                        <div class="text-2xl text-red-400 mb-1">GUEST</div>
                        <div id="final-score-guest" class="text-5xl font-bold text-white">0</div>
                    </div>
                </div>

                <div id="winner-banner" class="bg-gradient-to-r from-yellow-600 to-yellow-400 text-black font-bold text-3xl py-3 px-6 rounded-lg uppercase tracking-widest transform scale-110 mb-8 shadow-lg shadow-yellow-500/50">
                    Determining Winner...
                </div>

                <button onclick="resetGame()" class="bg-gray-700 hover:bg-gray-600 text-white px-8 py-3 rounded text-xl font-bold uppercase">
                    Back to Lobby
                </button>
            </div>
        </div>

    </main>

    <script>
        /**
         * PLAYER DATA DATABASE
         * R: Rings, S: Star Status (for Ringless mode), OVR: Rating
         */
        const PLAYERS_DB = [
            { id: 1, name: "Michael Jordan", team: "CHI", pos: "G", r: 6, s: true, ovr: 99 },
            { id: 2, name: "LeBron James", team: "LAL", pos: "F", r: 4, s: true, ovr: 98 },
            { id: 3, name: "Shaquille O'Neal", team: "LAL", pos: "C", r: 4, s: true, ovr: 97 },
            { id: 4, name: "Stephen Curry", team: "GSW", pos: "G", r: 4, s: true, ovr: 97 },
            { id: 5, name: "Nikola Jokic", team: "DEN", pos: "C", r: 1, s: true, ovr: 97 },
            { id: 6, name: "Kobe Bryant", team: "LAL", pos: "G", r: 5, s: true, ovr: 98 },
            { id: 7, name: "Tim Duncan", team: "SAS", pos: "F", r: 5, s: true, ovr: 96 },
            { id: 8, name: "Kevin Durant", team: "PHX", pos: "F", r: 2, s: true, ovr: 96 },
            { id: 9, name: "Giannis Antetokounmpo", team: "MIL", pos: "F", r: 1, s: true, ovr: 96 },
            { id: 10, name: "Hakeem Olajuwon", team: "HOU", pos: "C", r: 2, s: true, ovr: 96 },
            { id: 11, name: "Allen Iverson", team: "PHI", pos: "G", r: 0, s: true, ovr: 94 },
            { id: 12, name: "Charles Barkley", team: "PHX", pos: "F", r: 0, s: true, ovr: 93 },
            { id: 13, name: "Steve Nash", team: "PHX", pos: "G", r: 0, s: true, ovr: 92 },
            { id: 14, name: "James Harden", team: "LAC", pos: "G", r: 0, s: true, ovr: 91 },
            { id: 15, name: "Chris Paul", team: "GSW", pos: "G", r: 0, s: true, ovr: 90 },
            { id: 16, name: "Patrick Ewing", team: "NYK", pos: "C", r: 0, s: true, ovr: 90 },
            { id: 17, name: "Joel Embiid", team: "PHI", pos: "C", r: 0, s: true, ovr: 95 },
            { id: 18, name: "Luka Doncic", team: "DAL", pos: "G", r: 0, s: true, ovr: 96 },
            { id: 19, name: "Jayson Tatum", team: "BOS", pos: "F", r: 1, s: true, ovr: 94 },
            { id: 20, name: "Kawhi Leonard", team: "LAC", pos: "F", r: 2, s: true, ovr: 94 },
            { id: 21, name: "Jimmy Butler", team: "MIA", pos: "F", r: 0, s: false, ovr: 91 },
            { id: 22, name: "Paul George", team: "LAC", pos: "F", r: 0, s: false, ovr: 89 },
            { id: 23, name: "Damian Lillard", team: "MIL", pos: "G", r: 0, s: true, ovr: 91 },
            { id: 24, name: "Vince Carter", team: "TOR", pos: "G", r: 0, s: false, ovr: 88 },
            { id: 25, name: "Tracy McGrady", team: "ORL", pos: "G", r: 0, s: true, ovr: 90 },
            { id: 26, name: "Derrick Rose", team: "CHI", pos: "G", r: 0, s: false, ovr: 88 },
            { id: 27, name: "Reggie Miller", team: "IND", pos: "G", r: 0, s: false, ovr: 88 },
            { id: 28, name: "Karl Malone", team: "UTA", pos: "F", r: 0, s: true, ovr: 94 },
            { id: 29, name: "John Stockton", team: "UTA", pos: "G", r: 0, s: false, ovr: 91 },
            { id: 30, name: "Dwight Howard", team: "ORL", pos: "C", r: 1, s: false, ovr: 89 },
            { id: 31, name: "Carmelo Anthony", team: "NYK", pos: "F", r: 0, s: false, ovr: 89 },
            { id: 32, name: "Kyrie Irving", team: "DAL", pos: "G", r: 1, s: true, ovr: 92 },
            { id: 33, name: "Anthony Davis", team: "LAL", pos: "C", r: 1, s: true, ovr: 94 },
            { id: 34, name: "Russell Westbrook", team: "OKC", pos: "G", r: 0, s: false, ovr: 89 },
            { id: 35, name: "Klay Thompson", team: "GSW", pos: "G", r: 4, s: false, ovr: 88 },
            { id: 36, name: "Draymond Green", team: "GSW", pos: "F", r: 4, s: false, ovr: 86 },
            { id: 37, name: "Manu Ginobili", team: "SAS", pos: "G", r: 4, s: false, ovr: 88 },
            { id: 38, name: "Tony Parker", team: "SAS", pos: "G", r: 4, s: false, ovr: 89 },
            { id: 39, name: "Dennis Rodman", team: "CHI", pos: "F", r: 5, s: false, ovr: 88 },
            { id: 40, name: "Pau Gasol", team: "LAL", pos: "C", r: 2, s: false, ovr: 89 }
        ];

        // --- FIREBASE SETUP ---
        const firebaseConfig = {
            apiKey: "AIzaSyDCrKQVcGBW4iy7OMAtn4Jcf1ot5CGALBE",
            authDomain: "highnoon-66ee0.firebaseapp.com",
            databaseURL: "https://highnoon-66ee0-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "highnoon-66ee0",
            storageBucket: "highnoon-66ee0.firebasestorage.app",
            messagingSenderId: "754268761672",
            appId: "1:754268761672:web:7fbf59d2c403b43356727d"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        // Fixed App ID for your specific deployment
        const appId = 'nba-draft-game';

        // --- GLOBAL STATE ---
        let currentUser = null;
        let currentRoomId = null;
        let currentRoomData = null;
        let roomUnsubscribe = null;
        let myRole = null; // 'host' or 'guest'

        // --- AUTH & INIT ---
        async function initApp() {
            try {
                // Ensure "Anonymous" sign-in is enabled in your Firebase Console -> Authentication -> Sign-in method
                await auth.signInAnonymously();
            } catch (e) {
                console.error("Auth failed", e);
                showError("Authentication failed. Check console. Did you enable Anonymous Auth in Firebase?");
            }
        }

        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-info').textContent = `User: ${user.uid.slice(0,4)}...`;
            }
        });

        // --- ROOM LOGIC ---

        // Helper for DB refs
        const getRoomRef = (rid) => db.collection('artifacts').doc(appId).collection('public').doc('data').collection('nba_rooms').doc(rid);

        async function createRoom() {
            if (!currentUser) return;
            
            const roomId = Math.random().toString(36).substring(2, 8).toUpperCase();
            const roomRef = getRoomRef(roomId);

            const initialData = {
                hostId: currentUser.uid,
                guestId: null,
                status: 'waiting', // waiting, drafting, finished
                mode: 'classic',
                turnIndex: 0,
                turnOwner: 'host', // 'host' or 'guest'
                teamHost: [],
                teamGuest: [],
                takenPlayers: [],
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await roomRef.set(initialData);
                currentRoomId = roomId;
                myRole = 'host';
                enterLobby(roomId);
            } catch (e) {
                showError("Could not create room.");
            }
        }

        async function joinRoom() {
            if (!currentUser) return;
            const input = document.getElementById('room-input');
            const roomId = input.value.trim().toUpperCase();
            
            if (roomId.length < 2) {
                showError("Invalid Room ID");
                return;
            }

            const roomRef = getRoomRef(roomId);
            
            try {
                const doc = await roomRef.get();
                if (!doc.exists) {
                    showError("Room not found");
                    return;
                }
                const data = doc.data();

                if (data.status !== 'waiting' && data.guestId !== currentUser.uid) {
                    showError("Game already started or full");
                    return;
                }

                // If not already guest, join as guest
                if (data.hostId !== currentUser.uid && !data.guestId) {
                    await roomRef.update({
                        guestId: currentUser.uid,
                        status: 'drafting' // Start immediately upon join
                    });
                    myRole = 'guest';
                } else if (data.hostId === currentUser.uid) {
                    myRole = 'host';
                } else if (data.guestId === currentUser.uid) {
                    myRole = 'guest';
                } else {
                    showError("Room is full");
                    return;
                }

                currentRoomId = roomId;
                enterLobby(roomId);

            } catch (e) {
                console.error(e);
                showError("Error joining room");
            }
        }

        function enterLobby(roomId) {
            document.getElementById('view-lobby').classList.add('hidden');
            
            // Subscribe to room updates
            if (roomUnsubscribe) roomUnsubscribe();
            
            roomUnsubscribe = getRoomRef(roomId).onSnapshot((doc) => {
                if (!doc.exists) {
                    showError("Room deleted");
                    location.reload();
                    return;
                }
                
                const data = doc.data();
                currentRoomData = data;
                
                // Route to correct view
                if (data.status === 'waiting') {
                    document.getElementById('view-waiting').classList.remove('hidden');
                    document.getElementById('display-room-id').textContent = roomId;
                    document.getElementById('draft-room-id').textContent = roomId;
                    
                    // Host can change mode
                    const modeSel = document.getElementById('mode-select');
                    if (myRole === 'host') {
                        modeSel.disabled = false;
                        modeSel.value = data.mode;
                    } else {
                        modeSel.disabled = true;
                        modeSel.value = data.mode;
                    }
                    updateModeDesc(data.mode);

                } else if (data.status === 'drafting') {
                    document.getElementById('view-waiting').classList.add('hidden');
                    document.getElementById('view-draft').classList.remove('hidden');
                    document.getElementById('view-result').classList.add('hidden');
                    renderDraftBoard(data);
                } else if (data.status === 'finished') {
                    document.getElementById('view-draft').classList.remove('hidden'); // Keep board visible behind
                    document.getElementById('view-result').classList.remove('hidden');
                    renderResult(data);
                }
            }, (error) => {
                console.error("Listener failed", error);
            });
        }

        // --- GAME LOGIC ---

        async function updateGameMode() {
            if (!currentRoomId || myRole !== 'host') return;
            const mode = document.getElementById('mode-select').value;
            await getRoomRef(currentRoomId).update({ mode: mode });
        }

        function updateModeDesc(mode) {
            const desc = document.getElementById('mode-desc');
            const display = document.getElementById('game-mode-display');
            if (mode === 'classic') {
                desc.textContent = "Draft any 5 players. Highest total rating wins.";
                display.textContent = "Classic";
            } else {
                desc.textContent = "Draft 5 players. ONLY 1 can be a Champion/Star. The other 4 must have 0 rings.";
                display.textContent = "Ringless Challenge";
            }
        }

        function copyRoomId() {
            const id = document.getElementById('display-room-id').textContent;
            navigator.clipboard.writeText(id).then(() => {
                // simple feedback
                const el = document.getElementById('display-room-id');
                const orig = el.style.color;
                el.style.color = '#4ade80';
                setTimeout(() => el.style.color = '', 500);
            });
        }

        function renderDraftBoard(data) {
            // Update turn indicator
            const turnEl = document.getElementById('turn-indicator');
            const isMyTurn = data.turnOwner === myRole;
            
            if (isMyTurn) {
                turnEl.textContent = "YOUR PICK";
                turnEl.className = "px-4 py-1 bg-green-500 text-white font-bold rounded text-xl uppercase animate-pulse shadow-lg shadow-green-900/50";
            } else {
                turnEl.textContent = data.turnOwner === 'host' ? "Host's Turn" : "Guest's Turn";
                turnEl.className = "px-4 py-1 bg-gray-600 text-gray-300 font-bold rounded text-xl uppercase";
            }

            document.getElementById('game-mode-display').textContent = data.mode === 'classic' ? 'Classic' : 'Ringless';

            // Render Rosters
            renderRoster('host', data.teamHost);
            renderRoster('guest', data.teamGuest);
            
            // Calculate Scores (Live)
            document.getElementById('host-score').textContent = `Rating: ${calculateScore(data.teamHost)}`;
            document.getElementById('guest-score').textContent = `Rating: ${calculateScore(data.teamGuest)}`;

            // Render Pool
            renderPool(data);
        }

        function calculateScore(teamIds) {
            return teamIds.reduce((acc, pid) => {
                const p = PLAYERS_DB.find(pl => pl.id === pid);
                return acc + (p ? p.ovr : 0);
            }, 0);
        }

        function renderRoster(role, teamIds) {
            const container = document.getElementById(`roster-${role}`);
            container.innerHTML = '';
            
            // 5 slots
            for (let i = 0; i < 5; i++) {
                const pid = teamIds[i];
                const slot = document.createElement('div');
                slot.className = "bg-gray-800 border border-gray-700 p-2 rounded flex items-center gap-2 h-16 relative overflow-hidden";
                
                if (pid) {
                    const p = PLAYERS_DB.find(pl => pl.id === pid);
                    slot.innerHTML = `
                        <div class="font-bold text-2xl w-8 text-center text-gray-500">${p.pos}</div>
                        <div class="flex-1">
                            <div class="text-white font-bold leading-none uppercase truncate">${p.name}</div>
                            <div class="text-xs text-gray-400 flex gap-2">
                                <span>OVR: ${p.ovr}</span>
                                <span class="${p.r > 0 ? 'text-yellow-500' : 'text-gray-600'}"><i class="fas fa-trophy"></i> ${p.r}</span>
                            </div>
                        </div>
                    `;
                    // Highlight stars in Ringless mode
                    if (currentRoomData.mode === 'ringless' && (p.r > 0 || p.s)) {
                        slot.classList.add('border-yellow-500', 'bg-yellow-900/20');
                    }
                } else {
                    slot.innerHTML = `<div class="w-full text-center text-gray-600 text-sm uppercase tracking-widest">Empty Slot</div>`;
                }
                container.appendChild(slot);
            }
        }

        function renderPool(data) {
            const container = document.getElementById('player-pool');
            const search = document.getElementById('player-search').value.toLowerCase();
            const filter = document.getElementById('pos-filter').value;
            
            container.innerHTML = '';

            PLAYERS_DB.forEach(p => {
                // Filter Logic
                if (data.takenPlayers.includes(p.id)) return; // Don't show taken
                if (!p.name.toLowerCase().includes(search)) return;
                if (filter !== 'ALL' && p.pos !== filter) return;

                const card = document.createElement('div');
                
                // Logic to disable card if move is invalid
                let isValid = true;
                let reason = "";

                // Not your turn?
                if (data.turnOwner !== myRole) {
                    isValid = false;
                } 
                // Ringless Mode Validation
                else if (data.mode === 'ringless') {
                    const myTeam = myRole === 'host' ? data.teamHost : data.teamGuest;
                    const myPlayers = myTeam.map(id => PLAYERS_DB.find(x => x.id === id));
                    const hasStar = myPlayers.some(pl => pl.r > 0 || pl.s);
                    
                    // If I already have a star, I cannot pick another player with Rings > 0 or Star status
                    if (hasStar && (p.r > 0 || p.s)) {
                        isValid = false;
                        reason = "Limit: 1 Star";
                    }
                }

                card.className = `nba-card p-3 rounded border border-gray-700 relative cursor-pointer group ${!isValid ? 'disabled' : ''}`;
                card.onclick = () => { if(isValid) draftPlayer(p.id); };

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="bg-gray-700 text-xs px-1 rounded">${p.team}</span>
                        <span class="text-yellow-400 font-bold text-lg">${p.ovr}</span>
                    </div>
                    <div class="font-bold text-xl uppercase leading-tight mb-1 truncate">${p.name}</div>
                    <div class="flex justify-between items-end text-sm text-gray-400">
                        <span>${p.pos}</span>
                        <span class="${p.r > 0 ? 'text-yellow-500' : 'text-gray-600'}"><i class="fas fa-trophy"></i> ${p.r}</span>
                    </div>
                    ${!isValid && reason ? `<div class="absolute inset-0 bg-black/60 flex items-center justify-center text-red-400 font-bold uppercase text-sm">${reason}</div>` : ''}
                `;
                container.appendChild(card);
            });
        }

        // --- DRAFT ACTION ---

        async function draftPlayer(playerId) {
            if (!currentRoomData || currentRoomData.turnOwner !== myRole) return;
            
            // Transaction-like update logic
            // In a real app, use Firestore transactions. Here we just read/write for simplicity in 1 file
            // but we add checks.
            
            const ref = getRoomRef(currentRoomId);
            
            try {
                // Optimistic UI update could go here
                
                await db.runTransaction(async (transaction) => {
                    const doc = await transaction.get(ref);
                    if (!doc.exists) throw "Room does not exist!";
                    
                    const data = doc.data();
                    if (data.turnOwner !== myRole) throw "Not your turn!";
                    if (data.takenPlayers.includes(playerId)) throw "Player taken!";

                    // Snake Draft Logic
                    // Turn Sequence: H, G, G, H, H, G...
                    // 0 (H), 1 (G), 2 (G), 3 (H), 4 (H), 5 (G)...
                    // Logic: 
                    // Set next turn owner based on current index
                    const nextIndex = data.turnIndex + 1;
                    let nextOwner = 'host';
                    
                    // Simple pattern: H, G, H, G... (Alternating is easier for users to understand than Snake usually)
                    // But Prompt said: "team 1 picks, team 2 picks, team 1 again". That's alternating.
                    // Let's stick to strict alternating 1-2-1-2.
                    nextOwner = (data.turnOwner === 'host') ? 'guest' : 'host';

                    const newHostTeam = [...data.teamHost];
                    const newGuestTeam = [...data.teamGuest];

                    if (myRole === 'host') newHostTeam.push(playerId);
                    else newGuestTeam.push(playerId);

                    const newTaken = [...data.takenPlayers, playerId];

                    let newStatus = 'drafting';
                    // Check if full (5 players each = 10 total)
                    if (newTaken.length >= 10) {
                        newStatus = 'finished';
                    }

                    transaction.update(ref, {
                        teamHost: newHostTeam,
                        teamGuest: newGuestTeam,
                        takenPlayers: newTaken,
                        turnIndex: nextIndex,
                        turnOwner: nextOwner,
                        status: newStatus
                    });
                });

            } catch (e) {
                console.error("Draft error:", e);
                // showError("Draft failed: " + e);
            }
        }

        // --- RESULTS ---

        function renderResult(data) {
            const hScore = calculateScore(data.teamHost);
            const gScore = calculateScore(data.teamGuest);

            document.getElementById('final-score-host').textContent = hScore;
            document.getElementById('final-score-guest').textContent = gScore;

            const banner = document.getElementById('winner-banner');
            if (hScore > gScore) {
                banner.textContent = "HOST WINS!";
                banner.className = "bg-blue-600 text-white font-bold text-3xl py-3 px-6 rounded-lg uppercase tracking-widest transform scale-110 mb-8 shadow-lg";
            } else if (gScore > hScore) {
                banner.textContent = "GUEST WINS!";
                banner.className = "bg-red-600 text-white font-bold text-3xl py-3 px-6 rounded-lg uppercase tracking-widest transform scale-110 mb-8 shadow-lg";
            } else {
                banner.textContent = "IT'S A TIE!";
                banner.className = "bg-gray-600 text-white font-bold text-3xl py-3 px-6 rounded-lg uppercase tracking-widest transform scale-110 mb-8 shadow-lg";
            }
        }

        function resetGame() {
            location.reload();
        }

        // --- UTILS ---
        function showError(msg) {
            document.getElementById('modal-msg').textContent = msg;
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        // Search listener
        document.getElementById('player-search').addEventListener('input', () => {
            if (currentRoomData) renderPool(currentRoomData);
        });
        document.getElementById('pos-filter').addEventListener('change', () => {
            if (currentRoomData) renderPool(currentRoomData);
        });

        // Initialize
        window.onload = initApp;

    </script>
</body>
</html>
