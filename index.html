<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Aethelgard III: Civilization</title>
<style>
    :root {
        --bg: #121214;
        --panel: rgba(20, 20, 25, 0.95);
        --border: rgba(255, 255, 255, 0.1);
        --accent: #5e9cd1;
        --text: #e0e0e0;
        --gold: #ffd700;
        --magic: #b388eb;
        --crime: #ff4d4d;
        --item: #cd7f32;
        --build: #4caf50;
    }
    body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Segoe UI', monospace; color: var(--text); user-select: none; }
    canvas { display: block; width: 100vw; height: 100vh; cursor: crosshair; }
    
    /* UI Layout */
    .ui-layer { position: absolute; pointer-events: none; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
    .top-bar { top: 0; left: 0; right: 0; flex-direction: row; justify-content: space-between; pointer-events: auto; background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); padding: 10px 20px; }
    .bottom-bar { bottom: 0; left: 0; right: 0; pointer-events: auto; justify-content: center; align-items: center; padding-bottom: 20px; }
    .panel { background: var(--panel); backdrop-filter: blur(10px); border: 1px solid var(--border); border-radius: 8px; padding: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); pointer-events: auto; }
    
    /* Stats */
    .stat-group { display: flex; gap: 20px; font-size: 14px; font-weight: 600; text-shadow: 0 2px 4px black; }
    .stat-item span { color: var(--accent); margin-left: 5px; }
    
    /* Inspector */
    #inspector { top: 60px; left: 20px; width: 320px; max-height: 80vh; overflow-y: auto; display: none; font-size: 12px; }
    .inspector-row { display: flex; justify-content: space-between; margin-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom:2px;}
    .avatar { width: 45px; height: 45px; background: #222; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 26px; margin-right: 10px; border: 2px solid var(--accent); position: relative;}
    .header-row { display: flex; align-items: center; margin-bottom: 10px; }
    h2 { margin: 0; font-size: 16px; color: var(--gold); }
    h3 { margin: 0; font-size: 12px; color: #888; }
    
    /* Specialized Badges */
    .trait-badge { display: inline-block; padding: 2px 6px; background: #333; border-radius: 4px; margin: 2px; font-size: 10px; border: 1px solid #555; }
    .trait-magic { border-color: var(--magic); color: var(--magic); }
    .trait-crime { border-color: var(--crime); color: var(--crime); }
    .item-badge { border-color: var(--item); color: var(--item); }
    .build-badge { border-color: var(--build); color: var(--build); }
    
    /* Controls */
    .toolbar { display: flex; gap: 8px; background: var(--panel); padding: 8px 16px; border-radius: 50px; border: 1px solid var(--border); }
    button { background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: var(--text); padding: 6px 12px; border-radius: 4px; cursor: pointer; transition: all 0.2s; font-size: 12px; }
    button:hover { background: rgba(255,255,255,0.15); }
    button.active { background: var(--accent); color: #fff; border-color: transparent; }
    
    /* Toasts */
    #toast-container { bottom: 100px; right: 20px; width: 320px; align-items: flex-end; pointer-events: none; }
    .toast { background: rgba(0,0,0,0.9); border-left: 3px solid var(--accent); padding: 8px 12px; border-radius: 4px; margin-top: 6px; font-size: 11px; animation: fadeOut 6s forwards; pointer-events: auto; }
    .toast.crime { border-color: var(--crime); }
    .toast.magic { border-color: var(--magic); }
    .toast.item { border-color: var(--item); }
    .toast.build { border-color: var(--build); }
    
    @keyframes fadeOut { 0% { opacity:0; transform: translateX(20px); } 10% { opacity:1; transform: translateX(0); } 80% { opacity:1; } 100% { opacity: 0; display:none; } }
    
    /* Bars */
    .bar-con { width: 100%; background: #333; height: 4px; margin: 2px 0; border-radius: 2px; overflow: hidden; }
    .bar-fill { height: 100%; transition: width 0.5s; }
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-thumb { background: #444; }
</style>
</head>
<body>

<canvas id="gameCanvas"></canvas>

<div class="ui-layer top-bar">
    <div class="stat-group">
        <div class="stat-item">Year: <span id="ui-year">1</span></div>
        <div class="stat-item">Pop: <span id="ui-pop">0</span></div>
        <div class="stat-item">Avg Crime: <span id="ui-crime">0%</span></div>
    </div>
    <div class="toolbar">
        <button onclick="game.speed=0">‚è∏Ô∏è</button>
        <button onclick="game.speed=1" class="active" id="spd-1">‚ñ∂Ô∏è</button>
        <button onclick="game.speed=10" id="spd-10">‚è©</button>
    </div>
</div>

<div id="inspector" class="ui-layer panel"></div>

<div class="ui-layer bottom-bar">
    <div class="toolbar">
        <button onclick="ui.setTool('select')" id="btn-select" class="active">üëÜ Inspect</button>
        <button onclick="ui.setTool('drag')" id="btn-drag">‚úã Pan</button>
        <div style="width:1px; background:#444; margin:0 4px;"></div>
        <button onclick="ui.setTool('spawn_mob')" style="color:orange">üëπ Spawn Mob</button>
        <button onclick="ui.setTool('god_bless')" style="color:var(--gold)">‚ú® Bless</button>
        <button onclick="ui.setTool('god_smite')" style="color:var(--crime)">‚ö° Smite</button>
    </div>
</div>

<div id="toast-container" class="ui-layer"></div>

<script>
/** --- CONFIGURATION --- */
const CFG = {
    w: 150, h: 150,
    tileSize: 32,
    tickRate: 30,
    dayTicks: 50,
    yearDays: 120, 
    startCities: 3,
    maxMobs: 60
};

/** --- DATA & ASSETS --- */
const TILES = { WATER: 0, GRASS: 1, FOREST: 2, MOUNTAIN: 3, CITY: 4 };
const PALETTE = { 0: '#4173a3', 1: '#5c9e63', 2: '#3a7042', 3: '#7a7a7a', 4: '#333' };

const BUILDINGS = {
    HOUSE: { name: 'House', cost: {mat: 30, gold: 10}, color: '#8B4513', cap: 4 },
    FARM: { name: 'Farm', cost: {mat: 50, gold: 20}, color: '#9ACD32', jobs: 3 },
    MINE: { name: 'Mine', cost: {mat: 60, gold: 40}, color: '#696969', jobs: 3 },
    BARRACKS: { name: 'Barracks', cost: {mat: 100, gold: 80}, color: '#800000', jobs: 5 },
    SMITHY: { name: 'Smithy', cost: {mat: 150, gold: 100}, color: '#FFA500', jobs: 2 },
    BANK: { name: 'Bank', cost: {mat: 200, gold: 200}, color: '#FFD700', jobs: 2 }
};

const RACES = {
    HUMAN: { name: 'Human', emoji: 'üßë', life: 65, traits: ['Ambitious'], baseStats: {agg: 40, grd: 50, loy: 50} },
    ELF: { name: 'Elf', emoji: 'üßù', life: 180, traits: ['Arcane'], baseStats: {agg: 10, grd: 20, loy: 80} },
    ORC: { name: 'Orc', emoji: 'üëπ', life: 50, traits: ['Strong'], baseStats: {agg: 80, grd: 60, loy: 30} },
    DWARF: { name: 'Dwarf', emoji: 'üßî', life: 90, traits: ['Sturdy'], baseStats: {agg: 40, grd: 80, loy: 70} }
};

const JOBS = {
    IDLE: 'Vagrant', CHILD: 'Child', FARMER: 'Farmer', GUARD: 'Guard', 
    MAGE: 'Mage', THIEF: 'Thief', KING: 'Ruler', PRISONER: 'Prisoner',
    HUNTER: 'Hunter', SMITH: 'Blacksmith', BUILDER: 'Builder', MINER: 'Miner'
};

const ITEMS = {
    SWORD: { name: 'Iron Sword', type:'hand', atk: 15, def: 0, cost: 20 },
    AXE: { name: 'Battle Axe', type:'hand', atk: 20, def: -5, cost: 25 },
    ARMOR: { name: 'Chainmail', type:'body', atk: 0, def: 15, cost: 30 },
};

const MOBS = {
    DEER: { name: 'Deer', emoji: 'ü¶å', hp: 20, atk: 2, passive: true, food: 40, mat: 5 },
    BOAR: { name: 'Boar', emoji: 'üêó', hp: 30, atk: 8, passive: false, food: 50, mat: 10 },
    GOBLIN: { name: 'Goblin', emoji: 'üë∫', hp: 25, atk: 10, passive: false, loot: 5, mat: 5 },
    WOLF: { name: 'Wolf', emoji: 'üê∫', hp: 35, atk: 12, passive: false, food: 0, mat: 15 },
    BANDIT: { name: 'Bandit', emoji: 'ü•∑', hp: 60, atk: 15, passive: false, loot: 20, mat: 0 }
};

const GENETIC_TRAITS = {
    STRONG: { name: 'Strong', stat: 'str', mod: 20 },
    GENIUS: { name: 'Genius', stat: 'int', mod: 20 },
    ARCANE: { name: 'Arcane', stat: 'manaMax', mod: 50 },
    VIOLENT: { name: 'Violent', stat: 'agg', mod: 30 },
    CHARMING: { name: 'Charming', stat: 'cha', mod: 20 },
};

/** --- UTILS --- */
const rand = (n) => Math.floor(Math.random() * n);
const pick = (arr) => arr[rand(arr.length)];
const dist = (a, b) => Math.sqrt((a.x-b.x)**2 + (a.y-b.y)**2);
const uuid = () => Math.random().toString(36).substr(2, 9);
const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

/** --- ENGINE --- */
class Game {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.width = window.innerWidth;
        this.height = window.innerHeight;
        this.canvas.width = this.width;
        this.canvas.height = this.height;
        
        this.ticks = 0;
        this.speed = 1;
        this.camera = { x: 0, y: 0, z: 1.5, drag: false, lx: 0, ly: 0 };
        
        this.map = [];
        this.cities = [];
        this.units = [];
        this.mobs = [];
        this.particles = [];
        this.year = 1;
        this.day = 0;
        
        // Input
        this.canvas.onmousedown = e => {
            if(ui.tool === 'drag') { this.camera.drag = true; this.camera.lx = e.clientX; this.camera.ly = e.clientY; }
            else this.click(e);
        };
        window.onmousemove = e => {
            if(this.camera.drag) {
                this.camera.x -= (e.clientX - this.camera.lx) / this.camera.z;
                this.camera.y -= (e.clientY - this.camera.ly) / this.camera.z;
                this.camera.lx = e.clientX; this.camera.ly = e.clientY;
            }
        };
        window.onmouseup = () => this.camera.drag = false;
        window.onwheel = e => this.camera.z = clamp(this.camera.z - Math.sign(e.deltaY)*0.1, 0.5, 4);
    }

    init() {
        // Gen Map
        for(let y=0; y<CFG.h; y++) {
            let row = [];
            for(let x=0; x<CFG.w; x++) {
                let n = Math.sin(x*0.1) + Math.cos(y*0.1) + Math.random()*0.2;
                row.push(n < -0.5 ? TILES.WATER : (n > 1.2 ? TILES.MOUNTAIN : (n > 0.8 ? TILES.FOREST : TILES.GRASS)));
            }
            this.map.push(row);
        }

        // Gen Civs
        const races = Object.values(RACES);
        for(let i=0; i<CFG.startCities; i++) {
            let rx = rand(CFG.w), ry = rand(CFG.h);
            if(this.map[ry][rx] !== TILES.WATER) {
                this.createCity(rx, ry, races[i%races.length], i===0);
            }
        }
        
        this.loop();
    }

    createCity(x, y, race, isCapital) {
        const c = new City(x, y, race);
        if(isCapital) c.isCapital = true;
        this.cities.push(c);
        // Initial Pop
        for(let k=0; k<8; k++) this.spawnUnit(x, y, race, c);
        ui.toast(`${c.name} founded.`, 'build');
    }

    spawnUnit(x, y, race, city, parents=null) {
        const u = new Unit(x, y, race, parents);
        u.city = city;
        city.pop.push(u);
        this.units.push(u);
        return u;
    }
    
    spawnMob(type, x, y) {
        if(this.mobs.length >= CFG.maxMobs) return;
        if(this.map[Math.floor(y)][Math.floor(x)] === TILES.WATER) return;
        const m = new Mob(x, y, type);
        this.mobs.push(m);
        return m;
    }

    click(e) {
        const rect = this.canvas.getBoundingClientRect();
        const wx = (e.clientX - rect.left)/this.camera.z + this.camera.x;
        const wy = (e.clientY - rect.top)/this.camera.z + this.camera.y;
        const tx = Math.floor(wx/CFG.tileSize);
        const ty = Math.floor(wy/CFG.tileSize);
        
        if(ui.tool === 'select') {
            const m = this.mobs.find(u => Math.abs(u.x - tx) < 1 && Math.abs(u.y - ty) < 1);
            if(m) { ui.select(m); return; }
            const u = this.units.find(u => Math.abs(u.x - tx) < 1 && Math.abs(u.y - ty) < 1);
            if(u) { ui.select(u); return; }
            const c = this.cities.find(c => Math.abs(c.x - tx) < 2 && Math.abs(c.y - ty) < 2);
            if(c) { ui.select(c); return; }
            ui.select(null);
        } else if (ui.tool === 'god_smite') {
            const u = this.units.find(u => Math.abs(u.x - tx) < 1);
            if(u) u.die('Divine Smite');
            const m = this.mobs.find(m => Math.abs(m.x - tx) < 1);
            if(m) { m.die(); ui.toast('Mob Smited', 'crime'); }
        } else if (ui.tool === 'spawn_mob') {
            const keys = Object.keys(MOBS);
            this.spawnMob(MOBS[pick(keys)], tx, ty);
        }
    }

    loop() {
        requestAnimationFrame(() => this.loop());
        if(this.speed === 0) return;

        for(let s=0; s<this.speed; s++) {
            this.ticks++;
            if(this.ticks % CFG.dayTicks === 0) {
                this.day++;
                if(this.day > CFG.yearDays) { this.day=0; this.year++; ui.toast(`Year ${this.year}`); }
            }
            
            // Spawning Mobs
            if(this.ticks % 60 === 0 && this.mobs.length < CFG.maxMobs) {
                 let rx = rand(CFG.w), ry = rand(CFG.h);
                 if(!this.cities.some(c => dist(c, {x:rx, y:ry}) < 12)) {
                     const type = Math.random() > 0.6 ? pick([MOBS.GOBLIN, MOBS.WOLF, MOBS.BANDIT]) : pick([MOBS.DEER, MOBS.BOAR]);
                     this.spawnMob(type, rx, ry);
                 }
            }

            this.cities.forEach(c => c.update());
            this.units.forEach(u => u.update());
            this.mobs.forEach(m => m.update());
            
            this.units = this.units.filter(u => !u.dead);
            this.mobs = this.mobs.filter(m => !m.dead);

            this.particles.forEach(p => { p.y+=p.vy; p.life--; });
            this.particles = this.particles.filter(p => p.life > 0);
            
            if(this.ticks % 30 === 0) ui.update();
        }
        this.render();
    }

    render() {
        const c = this.ctx;
        const ts = CFG.tileSize;
        c.fillStyle = '#121214'; c.fillRect(0,0,this.width,this.height);
        c.save();
        c.scale(this.camera.z, this.camera.z);
        c.translate(-this.camera.x, -this.camera.y);

        // Map
        const vx = Math.floor(this.camera.x/ts), vy = Math.floor(this.camera.y/ts);
        const vw = this.width/this.camera.z/ts + 2, vh = this.height/this.camera.z/ts + 2;
        
        for(let y=Math.max(0,vy); y<Math.min(CFG.h, vy+vh); y++) {
            for(let x=Math.max(0,vx); x<Math.min(CFG.w, vx+vw); x++) {
                c.fillStyle = PALETTE[this.map[y][x]];
                c.fillRect(x*ts, y*ts, ts, ts);
            }
        }

        // Cities
        this.cities.forEach(city => {
            c.fillStyle = 'rgba(0,0,0,0.3)';
            c.fillRect(city.x*ts-ts, city.y*ts-ts, ts*3, ts*3);
            
            // Draw Buildings as small blocks
            let bx = city.x*ts, by = city.y*ts + ts;
            let i = 0;
            Object.entries(city.buildings).forEach(([type, count]) => {
                 for(let j=0; j<count; j++) {
                     c.fillStyle = BUILDINGS[type].color;
                     c.fillRect(bx + (i%5)*6 - 10, by + Math.floor(i/5)*6 - 20, 5, 5);
                     i++;
                 }
            });

            c.textAlign='center';
            c.font = '20px Arial';
            c.fillText(city.isCapital ? 'üè∞' : 'üèòÔ∏è', city.x*ts + ts/2, city.y*ts + ts/2);
            c.fillStyle='#fff'; c.font='10px Arial';
            c.fillText(city.name, city.x*ts+ts/2, city.y*ts-10);
            
            // Construction Bar
            if(city.currentBuild) {
                c.fillStyle = '#333'; c.fillRect(city.x*ts-10, city.y*ts+ts, 52, 6);
                c.fillStyle = '#4caf50'; c.fillRect(city.x*ts-9, city.y*ts+ts+1, (city.buildProgress/100)*50, 4);
            }
        });
        
        // Mobs
        this.mobs.forEach(m => {
             if(m.x < vx || m.x > vx+vw || m.y < vy || m.y > vy+vh) return;
             let px = m.x*ts, py = m.y*ts;
             c.font = `${ts*0.6}px Arial`; c.textAlign='center';
             c.fillText(m.type.emoji, px+ts/2, py+ts*0.8);
             c.fillStyle='red'; c.fillRect(px+2, py, (m.health/m.type.hp)*(ts-4), 3);
        });

        // Units
        this.units.forEach(u => {
            if(u.x < vx || u.x > vx+vw || u.y < vy || u.y > vy+vh) return;
            let px = u.x*ts, py = u.y*ts;
            if(ui.selected === u) { c.strokeStyle='#fff'; c.lineWidth=1; c.strokeRect(px, py, ts, ts); }
            
            c.font = `${ts*0.7}px Arial`; c.textAlign = 'center';
            let icon = u.emoji;
            if(u.job === JOBS.KING) icon = 'üëë';
            else if(u.job === JOBS.PRISONER) icon = '‚õìÔ∏è';
            else if(u.job === JOBS.BUILDER) icon = 'üî®';
            else if(u.dead) icon = 'üíÄ';
            
            c.fillText(icon, px+ts/2, py+ts*0.8);
            if(u.gear.hand) { c.font='8px Arial'; c.fillText('üó°Ô∏è', px+ts-4, py+10); }
            
            if(u.state === 'CRAFT') { c.fillStyle= '#cd7f32'; c.fillRect(px, py, ts, 2); }
        });

        this.particles.forEach(p => {
            c.globalAlpha = p.life/30;
            c.fillStyle = p.color;
            c.font = '12px Arial';
            c.fillText(p.txt, p.x*ts, p.y*ts);
        });
        c.globalAlpha = 1;
        c.restore();
    }
    
    addParticle(x, y, txt, color='#fff') {
        this.particles.push({x, y, txt, color, life:30, vy: -0.02});
    }
}

/** --- LOGIC CLASSES --- */
class Mob {
    constructor(x, y, type) {
        this.x = x; this.y = y;
        this.type = type;
        this.health = type.hp;
        this.dead = false;
        this.cooldown = 0;
    }
    update() {
        if(this.dead) return;
        if(this.cooldown > 0) this.cooldown--;
        let nearby = game.units.find(u => dist(this, u) < 5);
        if (nearby) {
            if(!this.type.passive) {
                this.moveTowards(nearby);
                if(dist(this, nearby) < 1 && this.cooldown === 0) {
                    nearby.health -= this.type.atk;
                    game.addParticle(nearby.x, nearby.y, 'üí•', 'red');
                    if(nearby.health <= 0) nearby.die(`Killed by ${this.type.name}`);
                    this.cooldown = 20;
                }
            } else if(dist(this, nearby) < 3) this.moveAway(nearby);
        } else {
            if(Math.random() < 0.05) this.target = {x: this.x + (Math.random()-0.5)*5, y: this.y + (Math.random()-0.5)*5};
            if(this.target) this.moveTowards(this.target);
        }
    }
    moveTowards(t) { const d = dist(this, t); if(d > 0.1) { this.x += (t.x - this.x)/d * 0.05; this.y += (t.y - this.y)/d * 0.05; } }
    moveAway(t) { const d = dist(this, t); if(d > 0.1) { this.x -= (t.x - this.x)/d * 0.06; this.y -= (t.y - this.y)/d * 0.06; } }
    die() { this.dead = true; game.addParticle(this.x, this.y, 'üíÄ'); }
}

class City {
    constructor(x, y, race) {
        this.name = race.name + 'ia ' + rand(99);
        this.x = x; this.y = y;
        this.race = race;
        this.pop = [];
        // Starting Resources
        this.resources = { food: 500, gold: 200, materials: 200 }; 
        this.storage = [];
        this.ruler = null;
        this.isCapital = false;
        this.buildings = { HOUSE: 1 }; // Start with 1 House
        this.currentBuild = null;
        this.buildProgress = 0;
    }

    update() {
        // Production
        const farmers = this.pop.filter(u=>u.job===JOBS.FARMER).length;
        const farms = (this.buildings.FARM || 0);
        const effectiveFarmers = Math.min(farmers, farms * BUILDINGS.FARM.jobs);
        // Farmers without farms forage (low yield), with farms (high yield)
        this.resources.food += (effectiveFarmers * 1.2) + ((farmers - effectiveFarmers) * 0.2);

        const miners = this.pop.filter(u=>u.job===JOBS.MINER).length;
        this.resources.materials += miners * 0.5;
        
        // Commerce (Banks generate gold)
        const banks = this.buildings.BANK || 0;
        this.resources.gold += (banks * 0.5) + (this.pop.length * 0.05); // Tax

        // Consumption
        if(game.ticks % 100 === 0) {
            this.resources.food -= this.pop.length * 1.0;
            if(this.resources.food < 0) {
                this.resources.food = 0;
                if(Math.random() < 0.2) pick(this.pop).die('Starvation');
            }
        }

        // Construction Queue Logic
        if(!this.currentBuild && game.ticks % 50 === 0) {
            this.decideBuild();
        }

        // Politics
        if(!this.ruler || this.ruler.dead) {
            const candidates = this.pop.filter(u => u.age > 18 && u.job !== JOBS.PRISONER);
            if(candidates.length) {
                candidates.sort((a,b) => (b.stats.cha + b.age) - (a.stats.cha + a.age));
                this.ruler = candidates[0];
                this.ruler.job = JOBS.KING;
                ui.toast(`${this.ruler.name} crowned in ${this.name}`, 'gold');
            }
        }
    }

    decideBuild() {
        // Priority 1: Houses if pop is near cap
        const cap = (this.buildings.HOUSE || 0) * BUILDINGS.HOUSE.cap + 4;
        if(this.pop.length >= cap - 2 && this.canAfford(BUILDINGS.HOUSE)) {
            this.startBuild('HOUSE'); return;
        }
        // Priority 2: Food
        if(this.resources.food < this.pop.length * 5 && this.canAfford(BUILDINGS.FARM)) {
            this.startBuild('FARM'); return;
        }
        // Priority 3: Materials
        if(this.resources.materials < 50 && this.canAfford(BUILDINGS.MINE)) {
            this.startBuild('MINE'); return;
        }
        // Priority 4: Military
        if(!this.buildings.BARRACKS && this.canAfford(BUILDINGS.BARRACKS)) {
            this.startBuild('BARRACKS'); return;
        }
        // Priority 5: Economy
        if(this.resources.gold > 300 && !this.buildings.BANK && this.canAfford(BUILDINGS.BANK)) {
            this.startBuild('BANK'); return;
        }
        // Priority 6: Crafting
        if(this.resources.materials > 300 && !this.buildings.SMITHY && this.canAfford(BUILDINGS.SMITHY)) {
            this.startBuild('SMITHY'); return;
        }
    }

    canAfford(b) { return this.resources.materials >= b.cost.mat && this.resources.gold >= b.cost.gold; }

    startBuild(type) {
        const b = BUILDINGS[type];
        this.resources.materials -= b.cost.mat;
        this.resources.gold -= b.cost.gold;
        this.currentBuild = type;
        this.buildProgress = 0;
        // ui.toast(`Construction started: ${b.name} in ${this.name}`);
    }
}

class Unit {
    constructor(x, y, race, parents) {
        this.id = uuid();
        this.name = this.genName();
        this.x = x; this.y = y;
        this.race = race;
        this.emoji = race.emoji;
        this.age = parents ? 0 : 18 + rand(20);
        this.health = 100;
        this.city = null;
        this.job = parents ? JOBS.CHILD : JOBS.IDLE;
        this.partner = null;
        this.children = 0;
        this.stats = { str: 10, int: 10, cha: 10 };
        this.traits = [];
        this.mixGenetics(parents, race);
        this.gear = { hand: null, body: null };
        this.personality = { agg: rand(100), grd: rand(100), loy: rand(100) };
        this.crime = 0; 
        this.mana = 0; this.maxMana = this.hasTrait('Arcane') ? 100 : 0;
        this.state = 'IDLE'; this.target = null; this.journal = [];
    }
    
    genName() { return pick(['Ar','Bor','Cal','Dan','El']) + pick(['on','us','ix','or','ia']); }
    hasTrait(name) { return this.traits.some(t => t.name === name); }
    
    mixGenetics(parents, race) {
        if(parents) {
             const [p1, p2] = parents;
             [...p1.traits, ...p2.traits].forEach(t => { if(Math.random()<0.5 && !this.hasTrait(t.name)) this.traits.push(t); });
        } else if(Math.random() < 0.3) this.traits.push(pick(Object.values(GENETIC_TRAITS)));
        this.traits.forEach(t => { if(t.stat === 'manaMax') this.maxMana = 100; else if(this.stats[t.stat]) this.stats[t.stat] += t.mod; });
    }

    getCombatStats() {
        let atk = this.stats.str/2, def = 0;
        if(this.gear.hand) { atk += this.gear.hand.atk; def += this.gear.hand.def; }
        if(this.gear.body) { atk += this.gear.body.atk; def += this.gear.body.def; }
        return { atk, def };
    }

    update() {
        if(this.dead) return;
        if(game.ticks % 100 === 0) {
            this.age += 0.1;
            if(this.age > this.race.life + 10) this.die('Old Age');
            if(this.maxMana > 0 && this.mana < this.maxMana) this.mana += 5;
            if(this.health < 100) this.health++;
        }
        if(this.job === JOBS.PRISONER) return;
        
        if(this.state === 'IDLE') this.decide();
        else this.act();
    }

    decide() {
        // Job Assignment
        if(this.job === JOBS.CHILD && this.age >= 18) this.job = JOBS.IDLE;
        if(this.job === JOBS.IDLE && this.city) {
            if(this.city.currentBuild) this.job = JOBS.BUILDER; // Need builders
            else if(this.hasTrait('Arcane')) this.job = JOBS.MAGE;
            else {
                // Job based on buildings
                const b = this.city.buildings;
                if((b.BARRACKS||0)*5 > this.countJob(JOBS.GUARD)) this.job = JOBS.GUARD;
                else if((b.SMITHY||0)*2 > this.countJob(JOBS.SMITH)) this.job = JOBS.SMITH;
                else if((b.FARM||0)*3 > this.countJob(JOBS.FARMER)) this.job = JOBS.FARMER;
                else if((b.MINE||0)*3 > this.countJob(JOBS.MINER)) this.job = JOBS.MINER;
                else this.job = Math.random() > 0.5 ? JOBS.MINER : JOBS.HUNTER; // Default jobs
            }
        }

        // Switch to Builder if city needs it and I'm not essential
        if(this.city && this.city.currentBuild && this.job !== JOBS.BUILDER && this.job !== JOBS.KING && this.job !== JOBS.GUARD) {
            if(Math.random() < 0.2) this.job = JOBS.BUILDER;
        }
        // Switch off Builder if done
        if(this.job === JOBS.BUILDER && !this.city.currentBuild) this.job = JOBS.IDLE;

        // Work Logic
        if(this.job === JOBS.BUILDER && this.city.currentBuild) {
             this.target = this.city; this.state = 'BUILD'; return;
        }
        if(this.job === JOBS.HUNTER) {
            const prey = game.mobs.find(m => m.type.passive && dist(this, m) < 20);
            if(prey) { this.target = prey; this.state = 'HUNT'; return; }
        }
        if(this.job === JOBS.GUARD) {
            const foe = game.mobs.find(m => !m.type.passive && dist(this, m) < 15);
            if(foe) { this.target = foe; this.state = 'ATTACK'; return; }
        }
        if(this.job === JOBS.SMITH && this.city.resources.materials >= 20 && Math.random() < 0.1) {
            this.state = 'CRAFT'; return;
        }
        
        // Reproduction
        if(this.age > 18 && this.age < 50 && this.partner && Math.random() < 0.002) {
             const houseCap = (this.city.buildings.HOUSE||0)*4 + 4;
             if(this.city.pop.length < houseCap && this.city.resources.food > 100) this.haveChild();
        }
        
        // Wander
        this.target = {x: this.x+(Math.random()-0.5)*5, y: this.y+(Math.random()-0.5)*5};
        this.state = 'MOVE';
    }
    
    countJob(j) { return this.city.pop.filter(u=>u.job===j).length; }

    act() {
        if(this.state === 'MOVE' && this.target) {
            const d = dist(this, this.target);
            if(d < 0.5) this.state = 'IDLE';
            else { this.x += (this.target.x-this.x)/d*0.1; this.y += (this.target.y-this.y)/d*0.1; }
        }
        else if(this.state === 'BUILD') {
            if(dist(this, this.city) > 3) { this.x += (this.city.x-this.x)*0.05; this.y += (this.city.y-this.y)*0.05; }
            else {
                this.city.buildProgress += 0.5;
                game.addParticle(this.x, this.y, 'üî®', '#4caf50');
                if(this.city.buildProgress >= 100) {
                    const t = this.city.currentBuild;
                    this.city.buildings[t] = (this.city.buildings[t] || 0) + 1;
                    ui.toast(`${this.city.name} built ${BUILDINGS[t].name}`, 'build');
                    this.city.currentBuild = null;
                    this.state = 'IDLE';
                }
            }
        }
        else if(this.state === 'HUNT' || this.state === 'ATTACK') {
            if(!this.target || this.target.dead) { this.state = 'IDLE'; return; }
            if(dist(this, this.target) < 1) {
                const cs = this.getCombatStats();
                this.target.health -= (cs.atk + rand(5));
                game.addParticle(this.target.x, this.target.y, 'üí•', 'orange');
                if(this.target.health <= 0) {
                    this.target.die();
                    if(this.city && this.target.type) {
                        this.city.resources.food += (this.target.type.food||0);
                        this.city.resources.materials += (this.target.type.mat||0);
                        this.city.resources.gold += (this.target.type.loot||0);
                    }
                }
                this.state = 'IDLE';
            } else {
                this.x += (this.target.x-this.x)*0.1; this.y += (this.target.y-this.y)*0.1;
            }
        }
        else if(this.state === 'CRAFT') {
            if(this.city.resources.materials >= 20) {
                const type = pick(Object.values(ITEMS));
                if(this.city.resources.materials >= type.cost) {
                    this.city.resources.materials -= type.cost;
                    this.city.storage.push(type);
                    game.addParticle(this.x, this.y, 'üõ†Ô∏è', '#cd7f32');
                    ui.toast(`${this.name} smithing: ${type.name}`, 'item');
                }
            }
            this.state = 'IDLE';
        }
    }

    haveChild() {
        this.city.resources.food -= 50;
        const baby = game.spawnUnit(this.x, this.y, this.race, this.city, [this, this.partner]);
        this.children++; this.partner.children++;
        game.addParticle(this.x, this.y, 'üë∂');
        ui.toast(`Birth: ${baby.name}`);
    }

    die(reason) {
        this.dead = true;
        if(this.city) this.city.pop = this.city.pop.filter(u => u !== this);
        game.addParticle(this.x, this.y, 'üíÄ', 'white');
    }
}

/** --- UI MANAGER --- */
const ui = {
    selected: null,
    tool: 'select',
    update: function() {
        document.getElementById('ui-year').innerText = game.year;
        document.getElementById('ui-pop').innerText = game.units.length;
        
        let totalCrime = 0; game.units.forEach(u => totalCrime += u.crime);
        let avg = game.units.length ? Math.floor(totalCrime/game.units.length) : 0;
        document.getElementById('ui-crime').innerText = avg + '%';
        if(this.selected) this.renderInspector();
    },
    select: function(obj) {
        this.selected = obj;
        document.getElementById('inspector').style.display = obj ? 'block' : 'none';
        if(obj) this.renderInspector();
    },
    setTool: function(t) {
        this.tool = t;
        document.querySelectorAll('.toolbar button').forEach(b => b.classList.remove('active'));
        const btn = document.getElementById(t==='select'?'btn-select':(t==='drag'?'btn-drag':''));
        if(btn) btn.classList.add('active');
    },
    toast: function(msg, type='') {
        const d = document.createElement('div'); d.className = `toast ${type}`; d.innerText = msg;
        document.getElementById('toast-container').appendChild(d);
        setTimeout(()=>d.remove(), 6000);
    },
    renderInspector: function() {
        const div = document.getElementById('inspector');
        const s = this.selected;
        if(s instanceof Unit) {
            let gearHtml = (s.gear.hand ? `üó°Ô∏è ${s.gear.hand.name} ` : '') + (s.gear.body ? `üõ°Ô∏è ${s.gear.body.name}` : '');
            div.innerHTML = `
                <div class="header-row">
                    <div class="avatar">${s.emoji}</div>
                    <div><h2>${s.name}</h2><h3>${s.job} | Age ${Math.floor(s.age)}</h3></div>
                </div>
                <div class="inspector-row"><span>Health</span> <span>${s.health}</span></div>
                <div class="inspector-row"><span>Action</span> <span style="color:#888">${s.state}</span></div>
                <div style="margin:5px 0; font-size:11px; color:var(--item)">${gearHtml || 'No Gear'}</div>
            `;
        } else if (s instanceof City) {
            let bHtml = Object.entries(s.buildings).map(([k,v]) => `<div>${BUILDINGS[k].name}: ${v}</div>`).join('');
            div.innerHTML = `
                <div class="header-row"><div class="avatar">üè∞</div><div><h2>${s.name}</h2><h3>Pop: ${s.pop.length}</h3></div></div>
                <div class="inspector-row"><span>Food</span> <span>${Math.floor(s.resources.food)}</span></div>
                <div class="inspector-row"><span>Gold</span> <span style="color:gold">${Math.floor(s.resources.gold)}</span></div>
                <div class="inspector-row"><span>Mats</span> <span style="color:#cd7f32">${Math.floor(s.resources.materials)}</span></div>
                <div style="margin-top:10px; border-top:1px solid #333; padding-top:5px;"><strong>Buildings</strong></div>
                <div style="display:grid; grid-template-columns:1fr 1fr; font-size:11px;">${bHtml}</div>
                ${s.currentBuild ? `<div style="margin-top:5px; color:lime">Building: ${BUILDINGS[s.currentBuild].name} (${Math.floor(s.buildProgress)}%)</div>` : ''}
            `;
        } else if (s instanceof Mob) {
             div.innerHTML = `<div class="header-row"><div class="avatar">${s.type.emoji}</div><div><h2>${s.type.name}</h2><h3>HP: ${s.health}</h3></div></div>`;
        }
    }
};

const game = new Game();
game.init();
</script>
</body>
</html>
