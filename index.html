<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Beyond Style Builder</title>
    <style>
        :root {
            --bg-body: #050505;
            --bg-panel: #111;
            --bg-card: #1a1a1a;
            --accent: #b91c1c;
            --text-main: #e5e5e5;
            --text-muted: #737373;
            --border: #333;
            --hex-bg: #1c1c1c;
        }

        * { box-sizing: border-box; }
        body {
            margin: 0; padding: 0;
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* --- LEFT PANEL: THE BUILDER --- */
        .builder-panel {
            width: 350px;
            background: #0a0a0a;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 10;
        }

        .builder-header {
            padding: 20px;
            background: var(--accent);
            color: white;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .builder-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .control-group { margin-bottom: 25px; }
        .control-label {
            color: var(--text-muted);
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: bold;
            margin-bottom: 8px;
            display: block;
        }

        /* Inputs */
        select, input[type="text"], input[type="number"] {
            width: 100%;
            background: #1a1a1a;
            border: 1px solid #333;
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        select:focus, input:focus { border-color: var(--accent); outline: none; }

        /* Stat Grid in Builder */
        .builder-stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            background: #161616;
            padding: 5px 10px;
            border-radius: 4px;
        }
        .builder-stat-label { font-weight: bold; font-size: 0.85rem; width: 40px; }
        .builder-stat-input { width: 50px; text-align: center; font-weight: bold; }
        .builder-bonus { color: var(--accent); font-size: 0.8rem; width: 30px; text-align: right; }

        /* Toggle Switch */
        .toggle-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .toggle-btn {
            background: #333; border: none; color: #888; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-size: 0.8rem;
        }
        .toggle-btn.active { background: var(--accent); color: white; }

        /* --- RIGHT PANEL: THE SHEET PREVIEW --- */
        .sheet-preview {
            flex-grow: 1;
            background: #000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* Re-using the exact Sheet Styles from before for Pixel-Perfect Layout */
        .dashboard {
            display: grid;
            grid-template-columns: 240px 1fr 240px;
            grid-template-rows: 90px 1fr;
            gap: 10px;
            padding: 10px;
            height: 100%;
            overflow: hidden;
        }

        /* HEADER */
        .header { grid-column: 1 / -1; display: flex; gap: 10px; }
        .char-info-panel { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 6px; padding: 10px 20px; width: 300px; display: flex; flex-direction: column; justify-content: center; }
        .char-name { font-size: 1.2rem; font-weight: bold; color: white; }
        .char-sub { font-size: 0.8rem; color: var(--text-muted); margin-top: 4px; }
        
        .vitals-panel { flex-grow: 1; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 6px; display: flex; align-items: center; padding: 0 20px; gap: 30px; }
        .vital-shield { width: 50px; height: 60px; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23555" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>') no-repeat center; background-size: contain; display: flex; flex-direction: column; align-items: center; justify-content: center; padding-bottom: 5px; }
        .vital-val { font-size: 1.4rem; font-weight: bold; }
        
        .hp-box { background: #000; border: 1px solid #333; border-radius: 4px; padding: 5px 15px; text-align: center; min-width: 120px; }
        .hp-bar-bg { height: 4px; background: #333; margin-top: 5px; width: 100%; position: relative; }
        .hp-bar-fill { height: 100%; background: var(--accent); width: 100%; transition: width 0.3s; }

        .session-log { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 6px; width: 300px; padding: 10px; display: flex; flex-direction: column; }
        .save-load { display: flex; justify-content: flex-end; gap: 5px; margin-bottom: 5px; }
        .sl-btn { background: #333; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 0.7rem; }
        .sl-btn:hover { background: var(--accent); }

        /* LEFT SIDEBAR STATS */
        .sidebar-left { grid-row: 2; overflow-y: auto; padding-right: 5px; }
        .stat-block { margin-bottom: 20px; }
        .stat-hex { width: 100%; height: 90px; background: var(--hex-bg); border: 2px solid var(--border); clip-path: polygon(15% 0, 85% 0, 100% 15%, 100% 85%, 85% 100%, 15% 100%, 0 85%, 0 15%); display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .stat-hex::before { content: ''; position: absolute; top: 2px; left: 2px; right: 2px; bottom: 2px; border: 1px solid #333; clip-path: polygon(15% 0, 85% 0, 100% 15%, 100% 85%, 85% 100%, 15% 100%, 0 85%, 0 15%); pointer-events: none; }
        .stat-big { font-size: 2rem; font-weight: bold; z-index: 2; }
        .stat-tiny { font-size: 1rem; margin-top: -5px; z-index: 2; }
        .stat-lbl { font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); margin-top: 2px; z-index: 2; }
        .stat-connector { position: absolute; right: -10px; top: 10px; width: 20px; height: 1px; background: #444; z-index: 0; }
        
        .skill-list { margin-top: 5px; padding-left: 10px; }
        .skill-row { display: flex; align-items: center; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 3px; }
        .skill-prof { width: 8px; height: 8px; border-radius: 50%; border: 1px solid #555; margin-right: 8px; }
        .skill-prof.active { background: var(--accent); border-color: var(--accent); }
        .skill-val { width: 25px; text-align: right; margin-right: 5px; color: var(--text-main); }

        /* CENTER CONTENT */
        .main-content { grid-row: 2; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 6px; display: flex; flex-direction: column; overflow: hidden; }
        .tabs { display: flex; border-bottom: 1px solid var(--border); background: #000; }
        .tab-btn { background: transparent; border: none; color: var(--text-muted); padding: 12px 20px; font-weight: bold; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: white; border-bottom-color: var(--accent); }
        .tab-pane { padding: 20px; overflow-y: auto; flex-grow: 1; display: none; }
        .tab-pane.show { display: block; }

        /* RIGHT SIDEBAR */
        .sidebar-right { grid-row: 2; overflow-y: auto; }
        .widget { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 6px; padding: 10px; margin-bottom: 10px; }
        .widget-title { text-align: center; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px; font-weight: bold; }
        .prof-text { font-size: 0.8rem; line-height: 1.6; color: #aaa; }

    </style>
</head>
<body>

    <input type="file" id="fileUpload" style="display:none" onchange="loadFromFile(this)">

    <div class="builder-panel">
        <div class="builder-header">
            Character Builder
            <span style="font-size:0.7rem; font-weight:normal; opacity:0.7;">v2.0</span>
        </div>
        <div class="builder-content">
            
            <div class="control-group">
                <label class="control-label">Name</label>
                <input type="text" id="inName" value="Ichibē Hyōsube" oninput="updateAll()">
            </div>

            <div class="control-group">
                <label class="control-label">Race</label>
                <select id="inRace" onchange="updateAll()">
                    <option value="Human">Human (+1 All)</option>
                    <option value="Goliath" selected>Goliath (+2 STR, +1 CON)</option>
                    <option value="Elf">Elf (+2 DEX)</option>
                    <option value="Dwarf">Dwarf (+2 CON)</option>
                    <option value="Oni">Oni (+2 STR, +1 CHA)</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label">Class</label>
                <select id="inClass" onchange="updateAll()">
                    <option value="Onomancer" selected>Onomancer (d8 Hit Die)</option>
                    <option value="Fighter">Fighter (d10 Hit Die)</option>
                    <option value="Wizard">Wizard (d6 Hit Die)</option>
                    <option value="Barbarian">Barbarian (d12 Hit Die)</option>
                    <option value="Rogue">Rogue (d8 Hit Die)</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label">Level</label>
                <input type="number" id="inLevel" value="5" min="1" max="20" oninput="updateAll()">
            </div>

            <div class="control-group">
                <label class="control-label">Base Ability Scores (Before Race)</label>
                <div id="statBuilder">
                    </div>
            </div>

            <div class="control-group">
                <div class="toggle-row">
                    <label class="control-label" style="margin:0">Hit Points</label>
                    <div>
                        <button class="toggle-btn active" id="btnHpFixed" onclick="setHpMode('fixed')">Fixed</button>
                        <button class="toggle-btn" id="btnHpManual" onclick="setHpMode('manual')">Manual</button>
                    </div>
                </div>
                <div id="hpAutoDisplay" style="font-size:0.8rem; color:#888; margin-top:5px;">
                    Calculating based on Class & CON...
                </div>
                <div id="hpManualInput" style="display:none; margin-top:5px;">
                    <input type="number" id="inHpManual" value="38" oninput="updateAll()">
                </div>
            </div>

        </div>
    </div>

    <div class="sheet-preview">
        <div class="dashboard">
            
            <div class="header">
                <div class="char-info-panel">
                    <div class="char-name" id="outName">Ichibē Hyōsube</div>
                    <div class="char-sub" id="outSub">The Onomancer 5 - Goliath</div>
                    <div style="font-size:0.75rem; margin-top:5px; color:#666;">
                        Proficiency Bonus: <span id="outProf" style="color:var(--accent); font-weight:bold;">+3</span>
                    </div>
                </div>

                <div class="vitals-panel">
                    <div class="vital-shield">
                        <div class="vital-val" id="outAC">16</div>
                        <div style="font-size:0.6rem;">AC</div>
                    </div>
                    <div class="vital-shield">
                        <div class="vital-val" id="outInit">+2</div>
                        <div style="font-size:0.6rem;">INIT</div>
                    </div>
                    <div class="vital-shield" style="background:none;">
                        <div style="text-align:center;">
                            <div class="vital-val" id="outSpeed">30</div>
                            <span style="font-size:0.6rem; text-transform:uppercase; color:#777;">Walk</span>
                        </div>
                    </div>

                    <div class="hp-box">
                        <div style="font-size:0.7rem; color:#888;">Hit Points</div>
                        <div style="font-size:1.2rem; font-weight:bold; color:white;">
                            <span id="outHpCurr">38</span> / <span id="outHpMax">38</span>
                        </div>
                        <div class="hp-bar-bg"><div class="hp-bar-fill" style="width:100%"></div></div>
                    </div>
                </div>

                <div class="session-log">
                    <div class="save-load">
                        <button class="sl-btn" onclick="saveData()">Save JSON</button>
                        <button class="sl-btn" onclick="document.getElementById('fileUpload').click()">Load JSON</button>
                    </div>
                    <textarea style="background:transparent; border:none; color:#777; width:100%; height:100%; font-family:inherit; font-size:0.8rem; resize:none;" placeholder="Session Notes..."></textarea>
                </div>
            </div>

            <div class="sidebar-left" id="statDisplay">
                </div>

            <div class="main-content">
                <div class="tabs">
                    <button class="tab-btn active">Actions</button>
                    <button class="tab-btn">Spells</button>
                    <button class="tab-btn">Features</button>
                </div>
                <div class="tab-pane show">
                    <div style="font-weight:bold; margin-bottom:10px;">Attacks</div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <div style="background:#222; padding:10px; border:1px solid #333; border-radius:4px;">
                            <div style="font-weight:bold;">The Great Brush</div>
                            <div style="font-size:0.8rem; color:#888;">Melee • 10ft Reach</div>
                            <div style="display:flex; justify-content:space-between; margin-top:5px;">
                                <span id="atkBonus" style="color:white; font-weight:bold;">+7</span>
                                <span style="color:#ccc;">1d10 + <span id="dmgMod">4</span> Force</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar-right">
                <div class="widget">
                    <div class="widget-title">Proficiencies</div>
                    <div class="prof-text">
                        <strong>Armor:</strong> Light, Medium<br>
                        <strong>Weapons:</strong> Simple, Martial<br>
                        <strong>Languages:</strong> Common, Giant
                    </div>
                </div>
                <div class="widget">
                    <div class="widget-title">Resistances</div>
                    <div class="prof-text" style="text-align:center; color:#555;">None</div>
                </div>
            </div>

        </div>
    </div>

<script>
    /* --- DATABASE --- */
    const STATS = ["Strength", "Dexterity", "Constitution", "Intelligence", "Wisdom", "Charisma"];
    
    const SKILL_MAP = {
        "Strength": ["Athletics"],
        "Dexterity": ["Acrobatics", "Sleight of Hand", "Stealth"],
        "Constitution": [],
        "Intelligence": ["Arcana", "History", "Investigation", "Nature", "Religion"],
        "Wisdom": ["Animal Handling", "Insight", "Medicine", "Perception", "Survival"],
        "Charisma": ["Deception", "Intimidation", "Performance", "Persuasion"]
    };

    const RACES = {
        "Human": { speed: 30, mods: [1,1,1,1,1,1] },
        "Goliath": { speed: 30, mods: [2,0,1,0,0,0] }, // STR, CON
        "Elf": { speed: 30, mods: [0,2,0,0,0,0] }, // DEX
        "Dwarf": { speed: 25, mods: [0,0,2,0,0,0] }, // CON
        "Oni": { speed: 30, mods: [2,0,0,0,0,1] } // STR, CHA
    };

    const CLASSES = {
        "Onomancer": { hitDie: 8, saves: ["Intelligence", "Wisdom"] },
        "Fighter": { hitDie: 10, saves: ["Strength", "Constitution"] },
        "Wizard": { hitDie: 6, saves: ["Intelligence", "Wisdom"] },
        "Barbarian": { hitDie: 12, saves: ["Strength", "Constitution"] },
        "Rogue": { hitDie: 8, saves: ["Dexterity", "Intelligence"] }
    };

    let hpMode = 'fixed';

    /* --- INIT --- */
    window.onload = function() {
        buildStatInputs();
        updateAll();
    };

    function buildStatInputs() {
        const container = document.getElementById('statBuilder');
        const defaultScores = [10, 14, 14, 12, 18, 8]; // From image
        
        STATS.forEach((stat, i) => {
            container.innerHTML += `
                <div class="builder-stat-row">
                    <div class="builder-stat-label">${stat.substring(0,3)}</div>
                    <input type="number" id="base${stat}" class="builder-stat-input" value="${defaultScores[i]}" oninput="updateAll()">
                    <div class="builder-bonus" id="bonus${stat}">+0</div>
                </div>
            `;
        });
    }

    /* --- CORE LOGIC --- */
    function updateAll() {
        // 1. Gather Inputs
        const name = document.getElementById('inName').value;
        const raceKey = document.getElementById('inRace').value;
        const classKey = document.getElementById('inClass').value;
        const level = parseInt(document.getElementById('inLevel').value) || 1;
        
        const raceData = RACES[raceKey];
        const classData = CLASSES[classKey];

        // 2. Calculate Proficiency: ceil(level / 4) + 1
        const prof = Math.ceil(level / 4) + 1;

        // 3. Process Stats & Bonuses
        const finalStats = {};
        const mods = {};

        STATS.forEach((stat, i) => {
            const base = parseInt(document.getElementById(`base${stat}`).value) || 10;
            const bonus = raceData.mods[i];
            
            // Update Builder UI
            document.getElementById(`bonus${stat}`).innerText = bonus > 0 ? `+${bonus}` : "+0";

            const final = base + bonus;
            finalStats[stat] = final;
            mods[stat] = Math.floor((final - 10) / 2);
        });

        // 4. Calculate HP
        let maxHp = 0;
        if (hpMode === 'fixed') {
            // Level 1: Max Die + Mod
            // Level 2+: Avg Die (Die/2 + 1) + Mod
            const conMod = mods["Constitution"];
            const hitDie = classData.hitDie;
            const lvl1 = hitDie + conMod;
            const subsequent = (hitDie / 2 + 1) + conMod;
            
            maxHp = lvl1 + ((level - 1) * subsequent);
            document.getElementById('hpAutoDisplay').innerText = `Auto: (${hitDie} + ${conMod}) + ${level-1}*(${hitDie/2+1} + ${conMod})`;
        } else {
            maxHp = parseInt(document.getElementById('inHpManual').value) || 10;
        }

        // 5. AC Calculation (Simple: 10 + DEX)
        // Note: Real D&D has armor logic, simplified here to Unarmored Defense basics
        const ac = 10 + mods["Dexterity"] + (classKey === "Barbarian" ? mods["Constitution"] : 0);

        // 6. UPDATE DOM (Sheet Preview)
        document.getElementById('outName').innerText = name;
        document.getElementById('outSub').innerText = `${classKey} ${level} - ${raceKey}`;
        document.getElementById('outProf').innerText = `+${prof}`;
        
        document.getElementById('outAC').innerText = ac;
        document.getElementById('outInit').innerText = fmt(mods["Dexterity"]);
        document.getElementById('outSpeed').innerText = raceData.speed;
        
        document.getElementById('outHpMax').innerText = maxHp;
        document.getElementById('outHpCurr').innerText = maxHp; // Reset current on build change for simplicity

        // Attack Bonus Demo (STR based)
        const atkStat = classKey === "Rogue" || classKey === "Monk" ? mods["Dexterity"] : mods["Strength"];
        document.getElementById('atkBonus').innerText = fmt(atkStat + prof);
        document.getElementById('dmgMod').innerText = atkStat;

        renderStatHexes(finalStats, mods, prof, classData.saves);
    }

    function renderStatHexes(stats, mods, prof, classSaves) {
        const container = document.getElementById('statDisplay');
        container.innerHTML = "";

        STATS.forEach(stat => {
            const mod = mods[stat];
            // Is Saving Throw Proficient?
            const isSaveProf = classSaves.includes(stat);
            const saveVal = mod + (isSaveProf ? prof : 0);

            let skillsHtml = `
                <div class="skill-row">
                    <div class="skill-prof ${isSaveProf?'active':''}"></div>
                    <div class="skill-val">${fmt(saveVal)}</div>
                    <div>Saving Throws</div>
                </div>
            `;

            // Skills
            SKILL_MAP[stat].forEach(skillName => {
                // Determine proficiency (Hardcoded basics from image for demo)
                // In a real full app, you'd select these in the builder too
                const knownProfs = ["Athletics", "Acrobatics", "Stealth", "Perception", "Insight", "Survival"];
                const isProf = knownProfs.includes(skillName);
                const skillVal = mod + (isProf ? prof : 0);
                
                skillsHtml += `
                    <div class="skill-row">
                        <div class="skill-prof ${isProf?'active':''}"></div>
                        <div class="skill-val">${fmt(skillVal)}</div>
                        <div>${skillName}</div>
                    </div>
                `;
            });

            container.innerHTML += `
                <div class="stat-block">
                    <div class="stat-hex">
                        <div class="stat-big">${stats[stat]}</div>
                        <div class="stat-tiny">${fmt(mod)}</div>
                        <div class="stat-lbl">${stat}</div>
                    </div>
                    <div class="stat-connector"></div>
                    <div class="skill-list">
                        ${skillsHtml}
                    </div>
                </div>
            `;
        });
    }

    /* --- HELPERS --- */
    function fmt(n) { return n >= 0 ? "+" + n : n; }

    function setHpMode(mode) {
        hpMode = mode;
        document.getElementById('btnHpFixed').className = mode === 'fixed' ? 'toggle-btn active' : 'toggle-btn';
        document.getElementById('btnHpManual').className = mode === 'manual' ? 'toggle-btn active' : 'toggle-btn';
        
        document.getElementById('hpAutoDisplay').style.display = mode === 'fixed' ? 'block' : 'none';
        document.getElementById('hpManualInput').style.display = mode === 'manual' ? 'block' : 'none';
        
        updateAll();
    }

    function saveData() {
        const data = {
            name: document.getElementById('inName').value,
            race: document.getElementById('inRace').value,
            class: document.getElementById('inClass').value,
            level: document.getElementById('inLevel').value,
            baseStats: STATS.map(s => document.getElementById(`base${s}`).value),
            hpMode: hpMode,
            manualHp: document.getElementById('inHpManual').value
        };
        const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'character_build.json';
        a.click();
    }

    function loadFromFile(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            const data = JSON.parse(e.target.result);
            document.getElementById('inName').value = data.name;
            document.getElementById('inRace').value = data.race;
            document.getElementById('inClass').value = data.class;
            document.getElementById('inLevel').value = data.level;
            
            STATS.forEach((s, i) => document.getElementById(`base${s}`).value = data.baseStats[i]);
            
            setHpMode(data.hpMode || 'fixed');
            if(data.manualHp) document.getElementById('inHpManual').value = data.manualHp;
            
            updateAll();
        };
        reader.readAsText(file);
    }
</script>

</body>
</html>
