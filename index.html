<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>High Noon Duel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rye&family=VT323&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Rye', serif;
            background-color: #000;
            color: #f3e5ab;
            overflow: hidden;
            touch-action: manipulation;
            user-select: none;
        }
        .pixel-font { font-family: 'VT323', monospace; }
        
        /* --- Animations --- */
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes sway { 0%, 100% { transform: rotate(-2deg) translateY(0); } 50% { transform: rotate(2deg) translateY(2px); } }
        @keyframes recoil { 
            0% { transform: translateY(0) scale(1); } 
            10% { transform: translateY(20px) scale(1.1) rotate(5deg); } 
            100% { transform: translateY(0) scale(1); } 
        }
        @keyframes muzzle-flash {
            0% { opacity: 1; transform: scale(0.5); }
            50% { opacity: 1; transform: scale(1.5); }
            100% { opacity: 0; transform: scale(2); }
        }
        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .animate-sway { animation: sway 3s infinite ease-in-out; }
        .animate-recoil { animation: recoil 0.2s cubic-bezier(0, 0, 0.2, 1); }
        .animate-slide-up { animation: slide-up 0.5s cubic-bezier(0.16, 1, 0.3, 1); }

        /* --- Game Elements --- */
        .crosshair { cursor: crosshair; }
        .locked { cursor: not-allowed; filter: grayscale(0.8); }
        
        .sky-gradient {
            background: linear-gradient(to bottom, #4a0e4e 0%, #812543 40%, #e68a4e 100%);
        }
        .sun {
            background: linear-gradient(to bottom, #ffd700, #ff8c00);
            box-shadow: 0 0 40px #ff4500;
        }
        
        /* Pixelated rendering for images if we had them, keeping CSS styles sharp */
        * { image-rendering: pixelated; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col relative">

    <!-- --- AUDIO SYSTEM (Hidden) --- -->
    <!-- Simple oscillator logic used in JS, no external files needed -->

    <!-- --- VIEW: APP CONTAINER --- -->
    <div id="app" class="w-full h-full flex flex-col relative bg-black">
        
        <!-- 1. LOGIN VIEW -->
        <div id="view-login" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-[url('https://www.transparenttextures.com/patterns/wood-pattern.png')] bg-amber-900">
            <div class="bg-black/60 p-8 rounded-xl border-4 border-amber-600 shadow-2xl text-center max-w-md w-full backdrop-blur-sm">
                <h1 class="text-5xl text-amber-400 mb-2 drop-shadow-lg">HIGH NOON</h1>
                <p class="text-amber-200 pixel-font text-xl mb-8">Multiplayer Reaction Shooter</p>
                
                <div class="space-y-4">
                    <input type="text" id="username-input" maxlength="10" placeholder="ENTER NAME" 
                           class="w-full bg-amber-950/80 text-amber-100 px-4 py-4 rounded border-2 border-amber-600 font-bold text-center text-xl focus:outline-none focus:ring-2 focus:ring-amber-400 placeholder-amber-700 pixel-font uppercase">
                    
                    <button id="btn-enter" class="w-full bg-amber-600 hover:bg-amber-500 text-black py-4 rounded font-bold text-xl tracking-widest border-b-4 border-amber-800 active:border-b-0 active:translate-y-1 transition-all">
                        ENTER SALOON
                    </button>
                </div>
                <div id="auth-status" class="mt-4 text-xs text-gray-500 pixel-font">Connecting to server...</div>
            </div>
        </div>

        <!-- 2. LOBBY VIEW -->
        <div id="view-lobby" class="absolute inset-0 z-40 flex flex-col bg-stone-900 hidden">
            <header class="p-4 bg-stone-800 border-b-4 border-stone-950 flex justify-between items-center shadow-lg z-10">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">üç∫</span>
                    <span class="text-amber-500 text-xl">THE SALOON</span>
                </div>
                <div class="text-right">
                    <div id="lobby-user-name" class="text-stone-300 font-bold">Guest</div>
                    <div class="text-xs text-stone-500 pixel-font" id="lobby-uid">ID: ...</div>
                </div>
            </header>
            
            <div class="flex-1 p-4 overflow-y-auto relative">
                <div class="absolute inset-0 opacity-10 pointer-events-none bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-amber-900 to-black"></div>
                
                <div class="flex justify-between items-end mb-2 relative z-10">
                    <h2 class="text-stone-400 pixel-font text-lg">OPEN TABLES</h2>
                    <button id="btn-refresh" class="text-amber-600 hover:text-amber-500 text-sm underline pixel-font">REFRESH LIST</button>
                </div>

                <div id="game-list" class="space-y-3 relative z-10 min-h-[200px]">
                    <!-- Games injected here -->
                    <div class="text-center text-stone-600 mt-10 pixel-font">Searching for opponents...</div>
                </div>
            </div>

            <div class="p-4 bg-stone-800 border-t-4 border-stone-950 z-10">
                <button id="btn-create" class="w-full bg-green-700 hover:bg-green-600 text-white py-4 rounded font-bold text-xl border-b-4 border-green-900 active:border-b-0 active:translate-y-1 transition-all shadow-lg flex flex-col items-center leading-tight">
                    <span>CREATE DUEL</span>
                    <span class="text-xs font-normal opacity-75 pixel-font">First to 3 ‚Ä¢ Win by 2</span>
                </button>
            </div>
        </div>

        <!-- 3. WAITING ROOM -->
        <div id="view-waiting" class="absolute inset-0 z-40 flex flex-col items-center justify-center bg-stone-950 hidden">
            <div class="text-center animate-float">
                <div class="text-6xl mb-4">üï∞Ô∏è</div>
                <h2 class="text-3xl text-amber-500 mb-2">WAITING FOR CHALLENGER</h2>
                <p class="text-stone-500 pixel-font text-lg">Code: <span id="waiting-code" class="text-stone-300 font-mono select-all">---</span></p>
            </div>
            <button id="btn-cancel-game" class="mt-12 px-6 py-2 border border-red-900 text-red-700 hover:bg-red-900/20 rounded transition-colors pixel-font">
                CANCEL
            </button>
        </div>

        <!-- 4. GAME ARENA (FPS STYLE) -->
        <div id="view-game" class="absolute inset-0 z-30 hidden flex flex-col overflow-hidden">
            
            <!-- Sky & Environment -->
            <div class="absolute inset-0 sky-gradient z-0"></div>
            <div class="absolute top-20 left-1/2 -translate-x-1/2 w-32 h-32 rounded-full sun z-0 opacity-80"></div>
            <div class="absolute bottom-0 left-0 w-full h-1/3 bg-[#3d2817] z-10 border-t-4 border-[#2a1a0f]"></div> <!-- Ground -->
            
            <!-- Decorative Background Elements -->
            <div class="absolute bottom-[33%] left-[10%] text-6xl opacity-40 z-0">üåµ</div>
            <div class="absolute bottom-[33%] right-[15%] text-4xl opacity-30 z-0">üåµ</div>
            <div class="absolute top-[20%] left-[20%] w-24 h-8 bg-white/10 rounded-full blur-xl"></div>

            <!-- Scoreboard (HUD) -->
            <div class="absolute top-4 left-4 right-4 z-50 flex justify-between items-start">
                <!-- My Score -->
                <div class="bg-black/50 p-2 rounded border border-amber-900/50 backdrop-blur">
                    <div class="text-xs text-amber-500 pixel-font">YOU</div>
                    <div class="flex gap-1" id="hud-my-score">
                        <div class="w-3 h-3 rounded-full bg-stone-700 border border-stone-500"></div>
                        <div class="w-3 h-3 rounded-full bg-stone-700 border border-stone-500"></div>
                        <div class="w-3 h-3 rounded-full bg-stone-700 border border-stone-500"></div>
                    </div>
                </div>
                
                <!-- Round Info -->
                <div class="bg-amber-900/80 px-4 py-1 rounded-b-lg shadow-lg border-x border-b border-amber-700">
                    <span class="pixel-font text-amber-100 text-xl">ROUND <span id="hud-round">1</span></span>
                </div>

                <!-- Enemy Score -->
                <div class="bg-black/50 p-2 rounded border border-amber-900/50 backdrop-blur text-right">
                    <div class="text-xs text-red-500 pixel-font">ENEMY</div>
                    <div class="flex gap-1 justify-end" id="hud-enemy-score">
                        <div class="w-3 h-3 rounded-full bg-stone-700 border border-stone-500"></div>
                        <div class="w-3 h-3 rounded-full bg-stone-700 border border-stone-500"></div>
                        <div class="w-3 h-3 rounded-full bg-stone-700 border border-stone-500"></div>
                    </div>
                </div>
            </div>

            <!-- Opponent Sprite (Distance) -->
            <div id="opponent-sprite" class="absolute bottom-[33%] left-1/2 -translate-x-1/2 w-16 h-32 z-10 transition-transform duration-100">
                <!-- Simple CSS Cowboy -->
                <div class="w-full h-full flex flex-col items-center">
                    <div class="w-10 h-4 bg-stone-800 rounded-t-lg"></div> <!-- Hat Top -->
                    <div class="w-16 h-2 bg-stone-800 -mt-1 rounded-full"></div> <!-- Hat Brim -->
                    <div class="w-8 h-8 bg-[#d4a373] rounded-b-lg relative"> <!-- Head -->
                         <div class="absolute top-3 left-2 w-1 h-1 bg-black rounded-full"></div>
                         <div class="absolute top-3 right-2 w-1 h-1 bg-black rounded-full"></div>
                    </div>
                    <div class="w-12 h-14 bg-red-800 rounded mt-1 relative"> <!-- Body -->
                        <div class="absolute top-2 left-0 w-full h-2 bg-black/20"></div> <!-- Poncho detail -->
                    </div>
                    <div class="w-10 h-16 flex justify-between"> <!-- Legs -->
                        <div class="w-4 h-full bg-stone-900"></div>
                        <div class="w-4 h-full bg-stone-900"></div>
                    </div>
                </div>
            </div>

            <!-- Hit Effect (Red Screen) -->
            <div id="hit-effect" class="absolute inset-0 bg-red-600 mix-blend-overlay opacity-0 pointer-events-none z-40 transition-opacity duration-75"></div>

            <!-- Center Message (The Signal) -->
            <div class="absolute inset-0 z-30 flex items-center justify-center pointer-events-none">
                <h1 id="main-message" class="text-7xl md:text-9xl font-black tracking-tighter text-white drop-shadow-[0_5px_5px_rgba(0,0,0,0.8)] transition-all scale-0">
                    DRAW!
                </h1>
                <p id="sub-message" class="absolute mt-32 text-amber-300 pixel-font text-xl bg-black/50 px-3 py-1 rounded hidden">
                    Wait for the signal...
                </p>
            </div>

            <!-- Player Weapon (First Person) -->
            <div id="weapon-container" class="absolute bottom-0 right-1/4 z-20 translate-y-full transition-transform duration-500">
                <div id="gun-hand" class="relative w-64 h-64 animate-sway origin-bottom-right">
                    <!-- Arm -->
                    <div class="absolute bottom-0 right-0 w-20 h-40 bg-[#d4a373] rotate-12 rounded-full border-l-4 border-black/10"></div>
                    <!-- Sleeve -->
                    <div class="absolute bottom-0 right-0 w-24 h-20 bg-blue-800 rotate-12"></div>
                    <!-- Gun -->
                    <div class="absolute bottom-32 right-12 w-40 h-12 bg-gray-800 rounded rotate-[-5deg] shadow-lg"></div>
                    <div class="absolute bottom-32 right-44 w-8 h-8 bg-gray-700 rounded-full border-4 border-gray-600"></div> <!-- Barrel tip -->
                    <div class="absolute bottom-24 right-10 w-12 h-16 bg-[#5d4037] rounded skew-x-12 border-2 border-[#3e2723]"></div> <!-- Handle -->
                    
                    <!-- Muzzle Flash (Hidden) -->
                    <div id="muzzle-flash" class="absolute bottom-36 right-52 w-24 h-24 bg-yellow-400 rounded-full blur-md opacity-0 mix-blend-screen"></div>
                </div>
            </div>

            <!-- Interaction Layer (The Trigger) -->
            <div id="trigger-zone" class="absolute inset-0 z-30 cursor-default"></div>

        </div>

        <!-- 5. ROUND/GAME OVER OVERLAY -->
        <div id="view-overlay" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-black/90 hidden backdrop-blur-md">
            <div class="text-center">
                <div id="overlay-icon" class="text-8xl mb-4 animate-bounce">üíÄ</div>
                <h2 id="overlay-title" class="text-6xl text-white mb-2 drop-shadow-lg font-black">YOU DIED</h2>
                <p id="overlay-sub" class="text-stone-400 pixel-font text-2xl mb-8">Round 1 Lost</p>
                
                <div id="overlay-score" class="flex justify-center gap-8 text-4xl mb-12 font-bold">
                    <div class="text-amber-500">YOU: <span id="score-me">0</span></div>
                    <div class="text-red-500">THEM: <span id="score-them">0</span></div>
                </div>

                <div id="next-round-timer" class="text-white pixel-font animate-pulse">Next round in 3...</div>
                
                <button id="btn-return-lobby" class="hidden px-8 py-4 bg-stone-700 hover:bg-stone-600 text-white rounded border-b-4 border-stone-900 font-bold text-xl">
                    RETURN TO TOWN
                </button>
            </div>
        </div>

    </div>

    <!-- --- LOGIC --- -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, updateDoc, onSnapshot, getDocs, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // 1. CONFIG
        const firebaseConfig = {
          apiKey: "AIzaSyDCrKQVcGBW4iy7OMAtn4Jcf1ot5CGALBE",
          authDomain: "highnoon-66ee0.firebaseapp.com",
          databaseURL: "https://highnoon-66ee0-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "highnoon-66ee0",
          storageBucket: "highnoon-66ee0.firebasestorage.app",
          messagingSenderId: "754268761672",
          appId: "1:754268761672:web:7fbf59d2c403b43356727d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const GAMES_COLLECTION = "high_noon_duels_v2"; // Versioned collection to avoid conflicts

        // 2. STATE
        let currentUser = null;
        let currentUserName = localStorage.getItem('cowboyName') || '';
        let currentGameId = null;
        let gameUnsubscribe = null;
        let myRole = null; 
        let gameState = 'login'; 
        let canShoot = false;
        let myScore = 0;
        let enemyScore = 0;

        // 3. UI REFERENCES
        const ui = {
            views: {
                login: document.getElementById('view-login'),
                lobby: document.getElementById('view-lobby'),
                waiting: document.getElementById('view-waiting'),
                game: document.getElementById('view-game'),
                overlay: document.getElementById('view-overlay')
            },
            inputs: { name: document.getElementById('username-input') },
            lobby: {
                badge: document.getElementById('lobby-uid'),
                name: document.getElementById('lobby-user-name'),
                list: document.getElementById('game-list'),
                createBtn: document.getElementById('btn-create')
            },
            game: {
                round: document.getElementById('hud-round'),
                myScore: document.getElementById('hud-my-score'),
                enemyScore: document.getElementById('hud-enemy-score'),
                mainMsg: document.getElementById('main-message'),
                subMsg: document.getElementById('sub-message'),
                weapon: document.getElementById('weapon-container'),
                gunHand: document.getElementById('gun-hand'),
                trigger: document.getElementById('trigger-zone'),
                muzzle: document.getElementById('muzzle-flash'),
                hitEffect: document.getElementById('hit-effect'),
                opponent: document.getElementById('opponent-sprite')
            },
            overlay: {
                icon: document.getElementById('overlay-icon'),
                title: document.getElementById('overlay-title'),
                sub: document.getElementById('overlay-sub'),
                scoreMe: document.getElementById('score-me'),
                scoreThem: document.getElementById('score-them'),
                timer: document.getElementById('next-round-timer'),
                returnBtn: document.getElementById('btn-return-lobby')
            }
        };

        // 4. SOUND SYSTEM
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            const now = audioCtx.currentTime;

            if (type === 'click') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(200, now);
                osc.frequency.exponentialRampToValueAtTime(0.01, now + 0.1);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                osc.start();
                osc.stop(now + 0.1);
            } 
            else if (type === 'shoot') {
                // Gunshot: Burst of noise + high pitch decay
                const bufferSize = audioCtx.sampleRate * 0.2;
                const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                
                const noise = audioCtx.createBufferSource();
                noise.buffer = buffer;
                noise.connect(gain);
                
                gain.gain.setValueAtTime(0.8, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                noise.start();

                // Punchy low end
                const kick = audioCtx.createOscillator();
                const kickGain = audioCtx.createGain();
                kick.connect(kickGain);
                kickGain.connect(audioCtx.destination);
                kick.frequency.setValueAtTime(150, now);
                kick.frequency.exponentialRampToValueAtTime(0.01, now + 0.1);
                kickGain.gain.setValueAtTime(0.5, now);
                kickGain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                kick.start();
                kick.stop(now + 0.1);
            } 
            else if (type === 'draw') {
                // Whistle or sharp alert
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.linearRampToValueAtTime(1200, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start();
                osc.stop(now + 0.3);
            }
            else if (type === 'jam') {
                // Dry fire click
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(800, now);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
                osc.start();
                osc.stop(now + 0.05);
            }
        }

        // 5. AUTH & NAVIGATION
        signInAnonymously(auth).catch(err => console.error("Auth:", err));

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-status').innerText = "Connected.";
                ui.lobby.badge.innerText = "ID: " + user.uid.slice(0, 4);
                if (currentUserName) {
                    ui.inputs.name.value = currentUserName;
                    switchView('lobby');
                    refreshGameList();
                } else {
                    switchView('login');
                }
            }
        });

        function switchView(viewName) {
            Object.values(ui.views).forEach(el => el.classList.add('hidden'));
            ui.views[viewName].classList.remove('hidden');
            gameState = viewName;
        }

        document.getElementById('btn-enter').addEventListener('click', () => {
            const name = ui.inputs.name.value.trim().toUpperCase();
            if (!name) return;
            currentUserName = name;
            localStorage.setItem('cowboyName', name);
            playSound('click');
            switchView('lobby');
            refreshGameList();
        });

        ui.lobby.createBtn.addEventListener('click', createGame);
        document.getElementById('btn-refresh').addEventListener('click', () => { playSound('click'); refreshGameList(); });
        document.getElementById('btn-cancel-game').addEventListener('click', leaveGame);
        ui.overlay.returnBtn.addEventListener('click', leaveGame);

        // 6. GAME LOBBY LOGIC
        async function refreshGameList() {
            ui.lobby.list.innerHTML = '<div class="text-center text-stone-500 pixel-font mt-8">Scanning horizon...</div>';
            try {
                const q = collection(db, GAMES_COLLECTION);
                const snapshot = await getDocs(q);
                ui.lobby.list.innerHTML = '';
                let found = false;
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    // Filter for waiting games
                    if (data.status === 'waiting') {
                        found = true;
                        const div = document.createElement('div');
                        div.className = 'bg-stone-800 border border-stone-700 p-4 rounded flex justify-between items-center hover:bg-stone-700 cursor-pointer transition-colors';
                        div.innerHTML = `
                            <div>
                                <div class="text-amber-500 font-bold text-lg">${data.hostName}</div>
                                <div class="text-xs text-stone-500 pixel-font">WAITING FOR CHALLENGER</div>
                            </div>
                            <button class="px-4 py-2 bg-amber-700 text-white rounded font-bold hover:bg-amber-600 pixel-font">DUEL</button>
                        `;
                        div.onclick = () => joinGame(docSnap.id);
                        ui.lobby.list.appendChild(div);
                    }
                });
                if (!found) ui.lobby.list.innerHTML = '<div class="text-center text-stone-600 pixel-font mt-8">No active duels found.<br>Be the first to draw.</div>';
            } catch (e) { console.error(e); }
        }

        // 7. CORE GAME FUNCTIONS
        async function createGame() {
            playSound('click');
            if(!currentUser) return;
            ui.lobby.createBtn.innerText = "CREATING...";
            try {
                const newRef = doc(collection(db, GAMES_COLLECTION));
                await setDoc(newRef, {
                    host: currentUser.uid,
                    hostName: currentUserName,
                    status: 'waiting',
                    round: 1,
                    hostScore: 0,
                    joinerScore: 0,
                    roundWinner: null,
                    createdAt: Date.now()
                });
                currentGameId = newRef.id;
                myRole = 'host';
                document.getElementById('waiting-code').innerText = currentGameId;
                switchView('waiting');
                subscribeToGame(currentGameId);
                ui.lobby.createBtn.innerText = "CREATE DUEL";
            } catch (e) {
                console.error(e);
                ui.lobby.createBtn.innerText = "ERROR";
            }
        }

        async function joinGame(gameId) {
            playSound('click');
            if(!currentUser) return;
            try {
                const gameRef = doc(db, GAMES_COLLECTION, gameId);
                await updateDoc(gameRef, {
                    joiner: currentUser.uid,
                    joinerName: currentUserName,
                    status: 'ready'
                });
                currentGameId = gameId;
                myRole = 'joiner';
                subscribeToGame(gameId);
            } catch (e) { console.error(e); }
        }

        function subscribeToGame(id) {
            if(gameUnsubscribe) gameUnsubscribe();
            gameUnsubscribe = onSnapshot(doc(db, GAMES_COLLECTION, id), (snap) => {
                if(!snap.exists()) { leaveGame(); return; }
                processGameState(snap.data());
            });
        }

        // 8. GAMEPLAY STATE MACHINE
        function processGameState(data) {
            // Waiting Room
            if(data.status === 'waiting') {
                if(gameState !== 'waiting' && myRole === 'host') switchView('waiting');
                return;
            }

            // Init Game UI
            if(gameState !== 'game' && gameState !== 'game_over') {
                switchView('game');
                if(myRole === 'host' && data.status === 'ready') {
                    // Host triggers the first countdown
                    startRoundSequence();
                }
            }

            // Score Updates
            updateScoreBoard(data);

            // States
            if(data.status === 'counting') {
                setWeaponState('holstered');
                ui.game.mainMsg.style.transform = "scale(0)"; // Hide Draw
                ui.game.subMsg.classList.remove('hidden'); // Show "Wait"
                ui.game.subMsg.innerText = "STEADY...";
                ui.game.trigger.classList.remove('crosshair');
                ui.game.trigger.classList.add('cursor-none'); // Hide cursor
                ui.views.overlay.classList.add('hidden'); // Hide overlay
                canShoot = false;
            } 
            else if (data.status === 'draw') {
                if(!canShoot && !data.roundWinner) {
                    // THE MOMENT
                    playSound('draw');
                    setWeaponState('drawn');
                    ui.game.subMsg.classList.add('hidden');
                    ui.game.mainMsg.style.transform = "scale(1)"; // Show DRAW
                    ui.game.mainMsg.classList.add('animate-pulse');
                    ui.game.trigger.classList.remove('cursor-none');
                    ui.game.trigger.classList.add('crosshair');
                    canShoot = true;
                }
            }

            // Round End Logic
            if(data.roundWinner) {
                canShoot = false;
                handleRoundEnd(data);
            }

            // Game Over Logic
            if(data.status === 'game_over') {
                showGameOver(data);
            }
        }

        // 9. VISUAL HELPERS
        function updateScoreBoard(data) {
            // Determine scores based on role
            if (myRole === 'host') {
                myScore = data.hostScore || 0;
                enemyScore = data.joinerScore || 0;
            } else {
                myScore = data.joinerScore || 0;
                enemyScore = data.hostScore || 0;
            }
            
            ui.game.round.innerText = data.round;
            
            // Render pips
            const renderPips = (score) => {
                return Array(3).fill(0).map((_, i) => `
                    <div class="w-3 h-3 rounded-full border border-stone-500 ${i < score ? 'bg-green-500 box-shadow-glow' : 'bg-stone-800'}"></div>
                `).join('');
            };
            
            ui.game.myScore.innerHTML = renderPips(myScore);
            ui.game.enemyScore.innerHTML = renderPips(enemyScore);
        }

        function setWeaponState(state) {
            const weapon = ui.game.weapon;
            if (state === 'holstered') {
                weapon.classList.add('translate-y-full'); // Slide down
            } else if (state === 'drawn') {
                weapon.classList.remove('translate-y-full'); // Slide up
            }
        }

        // 10. SHOOTING LOGIC
        ui.game.trigger.addEventListener('mousedown', fireWeapon);
        ui.game.trigger.addEventListener('touchstart', (e) => { e.preventDefault(); fireWeapon(); });

        async function fireWeapon() {
            if (!canShoot) {
                playSound('jam');
                return;
            }
            canShoot = false;
            playSound('shoot');
            
            // Visuals
            ui.game.gunHand.classList.remove('animate-sway');
            ui.game.gunHand.classList.add('animate-recoil');
            ui.game.muzzle.style.animation = 'muzzle-flash 0.1s forwards';
            setTimeout(() => {
                ui.game.gunHand.classList.remove('animate-recoil');
                ui.game.gunHand.classList.add('animate-sway');
                ui.game.muzzle.style.animation = '';
            }, 200);

            // Network
            try {
                // Attempt to claim the round. Firestore "First Write Wins" logic applies here roughly.
                const gameRef = doc(db, GAMES_COLLECTION, currentGameId);
                await updateDoc(gameRef, { 
                    roundWinner: currentUser.uid 
                });
            } catch (e) { console.log("Shot too slow", e); }
        }

        // 11. HOST GAME LOGIC (The Brain)
        async function startRoundSequence() {
            const gameRef = doc(db, GAMES_COLLECTION, currentGameId);
            await updateDoc(gameRef, { status: 'counting', roundWinner: null });
            
            // Random delay 2-6 seconds
            const delay = 2000 + Math.random() * 4000;
            setTimeout(async () => {
                // Ensure game hasn't been cancelled
                if (currentGameId) {
                    await updateDoc(gameRef, { status: 'draw' });
                }
            }, delay);
        }

        function handleRoundEnd(data) {
            // Show overlay
            ui.views.overlay.classList.remove('hidden');
            ui.overlay.returnBtn.classList.add('hidden');
            ui.overlay.timer.classList.remove('hidden');
            
            ui.overlay.scoreMe.innerText = myScore;
            ui.overlay.scoreThem.innerText = enemyScore;

            const iWon = data.roundWinner === currentUser.uid;
            
            if (iWon) {
                ui.overlay.icon.innerText = "ü§†";
                ui.overlay.title.innerText = "ROUND WON";
                ui.overlay.title.className = "text-6xl text-amber-400 mb-2 drop-shadow-lg font-black";
                ui.overlay.sub.innerText = "Fastest hand in the west.";
                
                // Animate opponent falling
                ui.game.opponent.style.transform = "translate(-50%, 0) rotate(90deg) translateY(50px)";
                ui.game.opponent.style.opacity = "0";
            } else {
                ui.overlay.icon.innerText = "üíÄ";
                ui.overlay.title.innerText = "ROUND LOST";
                ui.overlay.title.className = "text-6xl text-red-600 mb-2 drop-shadow-lg font-black";
                ui.overlay.sub.innerText = "You were too slow.";
                // Hit effect
                ui.game.hitEffect.style.opacity = "0.5";
                setTimeout(() => ui.game.hitEffect.style.opacity = "0", 500);
            }

            // HOST ONLY: Calculate Next Steps
            if (myRole === 'host') {
                // We need to process the score locally first to decide
                let hScore = data.hostScore;
                let jScore = data.joinerScore;

                // If this is the first time processing this round win (status is still draw)
                if (data.status === 'draw') {
                    if (data.roundWinner === currentUser.uid) hScore++;
                    else jScore++;

                    // Check Win Condition: First to 3 AND lead by 2
                    // Actually, "First to 3, Win by 2" means:
                    // (Score >= 3) AND (abs(diff) >= 2)
                    // If 3-2, play on. If 4-2, win.
                    // Standard interpretation: "First to 3" usually overrides "Win by 2" unless specified "Deuce".
                    // User said: "first to 3 win by 2".
                    
                    let winnerUid = null;
                    if (hScore >= 3 && (hScore - jScore) >= 2) winnerUid = currentUser.uid;
                    else if (jScore >= 3 && (jScore - hScore) >= 2) winnerUid = data.joiner; // We need joiner ID

                    // Update DB
                    const updatePayload = {
                        hostScore: hScore,
                        joinerScore: jScore,
                        status: winnerUid ? 'game_over' : 'counting_next' // Temp status to prevent loop
                    };
                    
                    if (winnerUid) updatePayload.gameWinner = winnerUid;

                    updateDoc(doc(db, GAMES_COLLECTION, currentGameId), updatePayload).then(() => {
                        if (!winnerUid) {
                            // Start next round timer
                            setTimeout(async () => {
                                await updateDoc(doc(db, GAMES_COLLECTION, currentGameId), {
                                    status: 'counting',
                                    roundWinner: null,
                                    round: data.round + 1
                                });
                                // Reset opponent visual for host (and joiner via state update)
                            }, 3000);
                        }
                    });
                }
            }
        }

        function showGameOver(data) {
            ui.views.overlay.classList.remove('hidden');
            ui.overlay.timer.classList.add('hidden');
            ui.overlay.returnBtn.classList.remove('hidden');
            
            const iWon = data.gameWinner === currentUser.uid;
            
            if(iWon) {
                ui.overlay.icon.innerText = "üèÜ";
                ui.overlay.title.innerText = "VICTORY";
                ui.overlay.title.className = "text-6xl text-yellow-400 mb-2 font-black";
                ui.overlay.sub.innerText = "The Legend Grows.";
            } else {
                ui.overlay.icon.innerText = "‚ö∞Ô∏è";
                ui.overlay.title.innerText = "DEFEAT";
                ui.overlay.title.className = "text-6xl text-stone-500 mb-2 font-black";
                ui.overlay.sub.innerText = "Buried in the sand.";
            }
        }

        // 12. CLEANUP
        async function leaveGame() {
            if(gameUnsubscribe) gameUnsubscribe();
            
            // Reset Visuals
            ui.game.opponent.style.transform = "translate(-50%, 0)";
            ui.game.opponent.style.opacity = "1";
            ui.game.hitEffect.style.opacity = "0";
            ui.views.overlay.classList.add('hidden');

            if(currentGameId && myRole === 'host') {
                try { await deleteDoc(doc(db, GAMES_COLLECTION, currentGameId)); } catch(e){}
            }
            currentGameId = null;
            myRole = null;
            switchView('lobby');
            refreshGameList();
        }

        window.oncontextmenu = (e) => { e.preventDefault(); return false; };
    </script>
</body>
</html>
